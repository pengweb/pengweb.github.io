<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>

	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<title> Mongoose--学习笔记 | 张鹏的全栈之路 </title>
	<meta property="og:title" content=" Mongoose--学习笔记 | 张鹏的全栈之路 " />
	<meta name="twitter:title" content=" Mongoose--学习笔记 | 张鹏的全栈之路 ">

	<meta property="og:type" content="article">
	<meta name="twitter:card" content="summary">

	<meta name="description" content=" Mongoose--学习笔记 | 张鹏的全栈之路 ">
	<meta property="og:description" content=" Mongoose--学习笔记 | 张鹏的全栈之路 " />
	<meta name="twitter:description" content=" Mongoose--学习笔记 | 张鹏的全栈之路 " />

	<link rel="icon" type="image/x-icon" href="/asset/img/favicon.png">

	<link rel="image_src" href="/asset/img/logo.png" >
	<meta property="og:image" content="/asset/img/logo.png" />

	<link href="http://yoursite.com/atom.xml" title="张鹏的全栈之路" type="application/atom+xml" rel="alternative">

	<link rel="canonical" href="/2016/04/07/Mongoose--学习笔记/index.html">

	<link rel="stylesheet" href="/asset/css/style.css">

</head>

<body>

	<div class="layout-header">
		<header class="header">
			<div class="layout-logo">
				<div class="panel-logo">

					<div class="box-logo box-log-md">
						<a href="/" title="张鹏的全栈之路"><img src="/asset/img/logo.png" class="img-logo"></a>
					</div>
					<div class="box-main-title">
						<h5 style="text-align: center">
							<span>Love life,love ourselves！--Pengzhang</span>
						</h5>
					</div>
					<div class="box-sub-title">

					</div>
				</div>
			</div>
			<div class="layout-menu">
				<div class="box-logo box-log-xs">
					<a href="/" title="张鹏的全栈之路"><img src="/asset/img/logo.png" class="img-logo"></a>
				</div>
				<div class="box-menu-list">
					<nav class="page-nav">
						<ul class="menu-list">

							<li class="box-menu-item"><a href="/"><span class="menu-item">HOME</span></a></li>

							<li class="box-menu-item"><a href="/tags/js"><span class="menu-item">Javascript</span></a></li>

							<li class="box-menu-item"><a href="/tags/nodejs"><span class="menu-item">Node.js</span></a></li>

							<li class="box-menu-item"><a href="/tags/html"><span class="menu-item">Html</span></a></li>

							<li class="box-menu-item"><a href="/tags/css"><span class="menu-item">Css</span></a></li>

							<li class="box-menu-item"><a href="/tags/note"><span class="menu-item">Note</span></a></li>

							<li class="box-menu-item"><a href="/tags/others"><span class="menu-item">Others</span></a></li>

							<li class="box-menu-item"><a href="/archives"><span class="menu-item">Sitemap</span></a></li>

						</ul>
					</nav>

				</div>
			</div>
		</header>
	</div>

	<div class="layout-content">


		<div class="row panel-content panel-post-item">
			<div class="box-post-item">
				<article class="post-item" itemscope itemtype="http://schema.org/Article">




					<p class="content-meta">
						<span class="meta-date" itemprop="datePublished" content="2016-04-07">2016-04-07</span>


					</p>


					<h2 class="box-content-title">
						<a href="/2016/04/07/Mongoose--学习笔记/"  itemprop="url"><span class="content-title" itemprop="name">Mongoose--学习笔记</span></a>
					</h2>

					<div class="content post-item-content" itemprop="articleBody">

<p>##一、快速通道</p>
<p>###1.1 名词解释</p>
<p><ul><br>    <li><code>Schema</code> ： 一种以文件形式存储的数据库模型骨架，不具备数据库的操作能力</li><br>    <li><code>Model</code> ： 由<code>Schema</code>发布生成的模型，具有抽象属性和行为的数据库操作对</li><br>    <li><code>Entity</code> ： 由<code>Model</code>创建的实体，他的操作也会影响数据库</li><br></ul><br><strong>注意</strong>：</p>
<p>1.本学习文档采用严格命名方式来区别不同对象，例如：</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">var</span> <span class="typ">PersonSchema</span><span class="pun">;</span>   <span class="com">//Person的文本属性</span><br>    <span class="kwd">var</span> <span class="typ">PersonModel</span><span class="pun">;</span>    <span class="com">//Person的数据库模型</span><br>    <span class="kwd">var</span> <span class="typ">PersonEntity</span><span class="pun">;</span>   <span class="com">//Person实体</span></code></pre><br>2.<code>Schema</code>、<code>Model</code>、<code>Entity</code>的关系请牢记，<code>Schema</code>生成<code>Model</code>，<code>Model</code>创造<code>Entity</code>，<code>Model</code>和<code>Entity</code>都可对数据库操作造成影响，但<code>Model</code>比<code>Entity</code>更具操作性。</p>
<p>##1.2 准备工作</p>
<p>1.首先你必须安装<a href="http://www.mongodb.org/" target="_blank">MongoDB</a>和<a href="http://nodejs.org/" target="_blank">NodeJS</a></p>
<p>2.在项目只能够创建一个数据库连接，如下:</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">var</span><span class="pln"> mongoose </span><span class="pun">=</span> <span class="kwd">require</span><span class="pun">(</span><span class="str">‘mongoose’</span><span class="pun">);</span>    <span class="com">//引用mongoose模块</span><br>    <span class="kwd">var</span><span class="pln"> db </span><span class="pun">=</span><span class="pln"> mongoose</span><span class="pun">.</span><span class="pln">createConnection</span><span class="pun">(</span><span class="str">‘localhost’</span><span class="pun">,</span><span class="str">‘test’</span><span class="pun">);</span> <span class="com">//创建一个数据库连接</span></code></pre><br>3.打开本机<code>localhost</code>的<code>test</code>数据库时，我们可以监测是否有异常</p>
<p><pre class="prettyprint language-javascript"><code><span class="pln">    db</span><span class="pun">.</span><span class="pln">on</span><span class="pun">(</span><span class="str">‘error’</span><span class="pun">,</span><span class="pln">console</span><span class="pun">.</span><span class="pln">error</span><span class="pun">.</span><span class="pln">bind</span><span class="pun">(</span><span class="pln">console</span><span class="pun">,</span><span class="str">‘连接错误:’</span><span class="pun">));</span><span class="pln"><br>    db</span><span class="pun">.</span><span class="pln">once</span><span class="pun">(</span><span class="str">‘open’</span><span class="pun">,</span><span class="kwd">function</span><span class="pun">(){</span><br>      <span class="com">//一次打开记录</span><br>    <span class="pun">});</span></code></pre><br><strong>注意</strong>：</p>
<p>成功开启数据库后，就可以执行数据库相应操作，假设以下代码都在回调中处理</p>
<p>4.定义一个<code>Schema</code></p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">var</span> <span class="typ">PersonSchema</span> <span class="pun">=</span> <span class="kwd">new</span><span class="pln"> mongoose</span><span class="pun">.</span><span class="typ">Schema</span><span class="pun">({</span><span class="pln"><br>      name</span><span class="pun">:</span><span class="typ">String</span>   <span class="com">//定义一个属性name，类型为String</span><br>    <span class="pun">});</span></code></pre><br>5.将该<code>Schema</code>发布为<code>Model</code></p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">var</span> <span class="typ">PersonModel</span> <span class="pun">=</span><span class="pln"> db</span><span class="pun">.</span><span class="pln">model</span><span class="pun">(</span><span class="str">‘Person’</span><span class="pun">,</span><span class="typ">PersonSchema</span><span class="pun">);</span><br>    <span class="com">//如果该Model已经发布，则可以直接通过名字索引到，如下：</span><br>    <span class="com">//var PersonModel = db.model(‘Person’);</span><br>    <span class="com">//如果没有发布，上一段代码将会异常</span></code></pre><br>6.用<code>Model</code>创建<code>Entity</code></p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">var</span><span class="pln"> personEntity </span><span class="pun">=</span> <span class="kwd">new</span> <span class="typ">PersonModel</span><span class="pun">({</span><span class="pln">name</span><span class="pun">:</span><span class="str">‘Krouky’</span><span class="pun">});</span><br>    <span class="com">//打印这个实体的名字看看</span><span class="pln"><br>    console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">personEntity</span><span class="pun">.</span><span class="pln">name</span><span class="pun">);</span> <span class="com">//Krouky</span></code></pre><br>7.我们甚至可以为此<code>Schema</code>创建方法</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="com">//为Schema模型追加speak方法</span><br>    <span class="typ">PersonSchema</span><span class="pun">.</span><span class="pln">methos</span><span class="pun">.</span><span class="pln">speak </span><span class="pun">=</span> <span class="kwd">function</span><span class="pun">(){</span><span class="pln"><br>      console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">‘我的名字叫’</span><span class="pun">+</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">name</span><span class="pun">);</span><br>    <span class="pun">}</span><br>    <span class="kwd">var</span> <span class="typ">PersonModel</span> <span class="pun">=</span><span class="pln"> db</span><span class="pun">.</span><span class="pln">model</span><span class="pun">(</span><span class="str">‘Person’</span><span class="pun">,</span><span class="typ">PersonSchema</span><span class="pun">);</span><br>    <span class="kwd">var</span><span class="pln"> personEntity </span><span class="pun">=</span> <span class="kwd">new</span> <span class="typ">PersonModel</span><span class="pun">({</span><span class="pln">name</span><span class="pun">:</span><span class="str">‘Krouky’</span><span class="pun">});</span><span class="pln"><br>    personEntity</span><span class="pun">.</span><span class="pln">speak</span><span class="pun">();</span><span class="com">//我的名字叫Krouky</span></code></pre><br>8.<code>Entity</code>是具有具体的数据库操作<code>CRUD</code>的</p>
<p><pre class="prettyprint language-javascript"><code><span class="pln">    personEntity</span><span class="pun">.</span><span class="pln">save</span><span class="pun">();</span>  <span class="com">//执行完成后，数据库就有该数据了</span></code></pre><br>9.如果要执行查询，需要依赖<code>Model</code>，当然<code>Entity</code>也是可以做到的</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="typ">PersonModel</span><span class="pun">.</span><span class="pln">find</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln">persons</span><span class="pun">){</span><br>      <span class="com">//查询到的所有person</span><br>    <span class="pun">});</span></code></pre><br><strong>注意</strong>：</p>
<ol>
<li><p>具体的如何配置<code>Schema</code>、<code>Model</code>以及<code>Model</code>和<code>Entity</code>的相关操作，我们会在后面进行</p>
</li>
<li><p><code>Model</code>和<code>Entity</code>都有能影响数据库的操作，但仍有区别，后面我们也会做解释</p>
</li>
</ol>
<p>##二、新手指引</p>
<p><em>如果您还不清楚<code>Mongoose</code>是如何工作的，请参看第一章快速通道快速浏览他的用法吧</em></p>
<p>###1. Schema——纯洁的数据库原型</p>
<p>####1.1 什么是Schema</p>
<p><ul><br>    <li>我理解<code>Schema</code>仅仅只是一断代码，他书写完成后程序依然无法使用，更无法通往数据库端</li><br>    <li>他仅仅只是数据库模型在程序片段中的一种表现，或者是数据属性模型</li><br></ul></p>
<p>####1.2 如何定义Schema</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">var</span> <span class="typ">BlogSchema</span> <span class="pun">=</span> <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">({</span><span class="pln"><br>      title</span><span class="pun">:</span><span class="typ">String</span><span class="pun">,</span><span class="pln"><br>      author</span><span class="pun">:</span><span class="typ">String</span><br>      <span class="com">//new Schema()中传入一个JSON对象，该对象形如 xxx:yyyy ,</span><br>      <span class="pun">/</span><span class="pln">xxx</span><span class="pun">是一个字符串，定义了属性，</span><span class="pln">yyy</span><span class="pun">是一个</span><span class="typ">Schema</span><span class="pun">.</span><span class="typ">Type</span><span class="pun">，定义了属性类型</span><br>    <span class="pun">});</span></code></pre></p>
<p>####1.3 什么是Schema.Type</p>
<p><code>Schema.Type</code>是由<code>Mongoose</code>内定的一些数据类型，基本数据类型都在其中，他也内置了一些<code>Mongoose</code>特有的<code>Schema.Type</code>。当然，你也可以自定义<code>Schema.Type</code>，只有满足<code>Schema.Type</code>的类型才能定义在<code>Schema</code>内。</p>
<p>####1.4 Schema.Types</p>
<p><code>NodeJS</code>中的基本数据类型都属于<code>Schema.Type</code>，另外<code>Mongoose</code>还定义了自己的类型</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="com">//举例：</span><br>    <span class="kwd">var</span> <span class="typ">ExampleSchema</span> <span class="pun">=</span> <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">({</span><span class="pln"><br>      name</span><span class="pun">:</span><span class="typ">String</span><span class="pun">,</span><span class="pln"><br>      binary</span><span class="pun">:</span><span class="typ">Buffer</span><span class="pun">,</span><span class="pln"><br>      living</span><span class="pun">:</span><span class="typ">Boolean</span><span class="pun">,</span><span class="pln"><br>      updated</span><span class="pun">:</span><span class="typ">Date</span><span class="pun">,</span><span class="pln"><br>      age</span><span class="pun">:</span><span class="typ">Number</span><span class="pun">,</span><span class="pln"><br>      mixed</span><span class="pun">:</span><span class="typ">Schema</span><span class="pun">.</span><span class="typ">Types</span><span class="pun">.</span><span class="typ">Mixed</span><span class="pun">,</span> <span class="com">//该混合类型等同于nested</span><span class="pln"><br>      _id</span><span class="pun">:</span><span class="typ">Schema</span><span class="pun">.</span><span class="typ">Types</span><span class="pun">.</span><span class="typ">ObjectId</span><span class="pun">,</span>  <span class="com">//主键</span><span class="pln"><br>      _fk</span><span class="pun">:</span><span class="typ">Schema</span><span class="pun">.</span><span class="typ">Types</span><span class="pun">.</span><span class="typ">ObjectId</span><span class="pun">,</span>  <span class="com">//外键</span><span class="pln"><br>      array</span><span class="pun">:[],</span><span class="pln"><br>      arrOfString</span><span class="pun">:[</span><span class="typ">String</span><span class="pun">],</span><span class="pln"><br>      arrOfNumber</span><span class="pun">:[</span><span class="typ">Number</span><span class="pun">],</span><span class="pln"><br>      arrOfDate</span><span class="pun">:[</span><span class="typ">Date</span><span class="pun">],</span><span class="pln"><br>      arrOfBuffer</span><span class="pun">:[</span><span class="typ">Buffer</span><span class="pun">],</span><span class="pln"><br>      arrOfBoolean</span><span class="pun">:[</span><span class="typ">Boolean</span><span class="pun">],</span><span class="pln"><br>      arrOfMixed</span><span class="pun">:[</span><span class="typ">Schema</span><span class="pun">.</span><span class="typ">Types</span><span class="pun">.</span><span class="typ">Mixed</span><span class="pun">],</span><span class="pln"><br>      arrOfObjectId</span><span class="pun">:[</span><span class="typ">Schema</span><span class="pun">.</span><span class="typ">Types</span><span class="pun">.</span><span class="typ">ObjectId</span><span class="pun">]</span><span class="pln"><br>      nested</span><span class="pun">:{</span><span class="pln"><br>        stuff</span><span class="pun">:</span><span class="typ">String</span><span class="pun">,</span><br>      <span class="pun">}</span><br>    <span class="pun">});</span></code></pre></p>
<p>####1.5 关于Buffer</p>
<p><code>Buffer</code>和<code>ArrayBuffer</code>是<code>Nodejs</code>两种隐藏的对象，相关内容请查看<code>NodeJS-API</code></p>
<p>####1.6 关于Mixed</p>
<p><code>Schema.Types.Mixed</code>是<code>Mongoose</code>定义个混合类型，该混合类型如果未定义具体形式。因此,如果定义具体内容，就直接使用<code>{}</code>来定义，以下两句等价</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">var</span> <span class="typ">AnySchema</span> <span class="pun">=</span> <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">({</span><span class="pln">any</span><span class="pun">:{}});</span><br>    <span class="kwd">var</span> <span class="typ">AnySchema</span> <span class="pun">=</span> <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">({</span><span class="pln">any</span><span class="pun">:</span><span class="typ">Schema</span><span class="pun">.</span><span class="typ">Types</span><span class="pun">.</span><span class="typ">Mixed</span><span class="pun">});</span></code></pre><br>混合类型因为没有特定约束，因此可以任意修改，一旦修改了原型，则必须调用<code>markModified()</code></p>
<p><pre class="prettyprint language-javascript"><code><span class="pln">    person</span><span class="pun">.</span><span class="pln">anything </span><span class="pun">=</span> <span class="pun">{</span><span class="pln">x</span><span class="pun">:[</span><span class="lit">3</span><span class="pun">,</span><span class="lit">4</span><span class="pun">,{</span><span class="pln">y</span><span class="pun">:</span><span class="str">‘change’</span><span class="pun">}]}</span><span class="pln"><br>    person</span><span class="pun">.</span><span class="pln">markModified</span><span class="pun">(</span><span class="str">‘anything’</span><span class="pun">);</span><span class="com">//传入anything，表示该属性类型发生变化</span><span class="pln"><br>    person</span><span class="pun">.</span><span class="pln">save</span><span class="pun">();</span></code></pre></p>
<p>####1.7 关于ObjectId</p>
<p>主键，一种特殊而且非常重要的类型，每个<code>Schema</code>都会默认配置这个属性，属性名为<code>_id</code>，除非自己定义，方可覆盖</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">var</span><span class="pln"> mongoose </span><span class="pun">=</span> <span class="kwd">require</span><span class="pun">(</span><span class="str">‘mongoose’</span><span class="pun">);</span><br>    <span class="kwd">var</span> <span class="typ">ObjectId</span> <span class="pun">=</span><span class="pln"> mongoose</span><span class="pun">.</span><span class="typ">Schema</span><span class="pun">.</span><span class="typ">Types</span><span class="pun">.</span><span class="typ">ObjectId</span><span class="pun">;</span><br>    <span class="kwd">var</span> <span class="typ">StudentSchema</span> <span class="pun">=</span> <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">({});</span> <span class="com">//默认会有_id:ObjectId</span><br>    <span class="kwd">var</span> <span class="typ">TeacherSchema</span> <span class="pun">=</span> <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">({</span><span class="pln">id</span><span class="pun">:</span><span class="typ">ObjectId</span><span class="pun">});</span><span class="com">//只有id:ObjectId</span></code></pre><br>该类型的值由系统自己生成，从某种意义上几乎不会重复，生成过程比较复杂，有兴趣的朋友可以查看源码。</p>
<p>####1.8 关于Array</p>
<p><code>Array</code>在<code>JavaScript</code>编程语言中并不是数组，而是集合，因此里面可以存入不同的值，以下代码等价：</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">var</span> <span class="typ">ExampleSchema1</span> <span class="pun">=</span> <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">({</span><span class="pln">array</span><span class="pun">:[]});</span><br>    <span class="kwd">var</span> <span class="typ">ExampleSchema2</span> <span class="pun">=</span> <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">({</span><span class="pln">array</span><span class="pun">:</span><span class="typ">Array</span><span class="pun">});</span><br>    <span class="kwd">var</span> <span class="typ">ExampleSchema3</span> <span class="pun">=</span> <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">({</span><span class="pln">array</span><span class="pun">:[</span><span class="typ">Schema</span><span class="pun">.</span><span class="typ">Types</span><span class="pun">.</span><span class="typ">Mixed</span><span class="pun">]});</span><br>    <span class="kwd">var</span> <span class="typ">ExampleSchema4</span> <span class="pun">=</span> <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">({</span><span class="pln">array</span><span class="pun">:[{}]});</span></code></pre></p>
<p>####1.9 附言</p>
<p><code>Schema</code>不仅定义了<code>文档结构</code>和<code>使用性能</code>，还可以有<code>扩展插件</code>、<code>实例方法</code>、<code>静态方法</code>、<code>复合索引</code>、<code>文档生命周期钩子</code></p>
<p><code>Schema</code>可以定义插件，并且插件具有良好的可拔插性，请有兴趣的读者继续往后阅读或者查阅官方资料。</p>
<p>###2. Schema的扩展</p>
<p>####2.1 实例方法</p>
<p>有的时候，我们创造的<code>Schema</code>不仅要为后面的<code>Model</code>和<code>Entity</code>提供公共的属性，还要提供公共的方法。</p>
<p>下面例子比快速通道的例子更加高级，可以进行高级扩展：</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">var</span> <span class="typ">PersonSchema</span> <span class="pun">=</span> <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">({</span><span class="pln">name</span><span class="pun">:</span><span class="typ">String</span><span class="pun">,</span><span class="pln">type</span><span class="pun">:</span><span class="typ">String</span><span class="pun">});</span><br>    <span class="com">//查询类似数据</span><br>    <span class="typ">PersonSchema</span><span class="pun">.</span><span class="pln">methods</span><span class="pun">.</span><span class="pln">findSimilarTypes </span><span class="pun">=</span> <span class="kwd">function</span><span class="pun">(</span><span class="pln">cb</span><span class="pun">){</span><br>      <span class="kwd">return</span> <span class="kwd">this</span><span class="pun">.</span><span class="pln">model</span><span class="pun">(</span><span class="str">‘Person’</span><span class="pun">).</span><span class="pln">find</span><span class="pun">({</span><span class="pln">type</span><span class="pun">:</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">type</span><span class="pun">},</span><span class="pln">cb</span><span class="pun">);</span><br>    <span class="pun">}</span></code></pre><br>使用如下：</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">var</span> <span class="typ">PersonModel</span> <span class="pun">=</span><span class="pln"> mongoose</span><span class="pun">.</span><span class="pln">model</span><span class="pun">(</span><span class="str">‘Person’</span><span class="pun">,</span><span class="typ">PersonSchema</span><span class="pun">);</span><br>    <span class="kwd">var</span><span class="pln"> krouky </span><span class="pun">=</span> <span class="kwd">new</span> <span class="typ">PersonSchema</span><span class="pun">({</span><span class="pln">name</span><span class="pun">:</span><span class="str">‘krouky’</span><span class="pun">,</span><span class="pln">type</span><span class="pun">:</span><span class="str">‘前端工程师’</span><span class="pun">});</span><span class="pln"><br>    krouky</span><span class="pun">.</span><span class="pln">findSimilarTypes</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln">persons</span><span class="pun">){</span><br>      <span class="com">//persons中就能查询到其他前端工程师</span><br>    <span class="pun">});</span></code></pre></p>
<p>####2.2 静态方法</p>
<p>静态方法在<code>Model</code>层就能使用，如下：</p>
<p><pre class="prettyprint language-javascript"><code>  <span class="typ">PersonSchema</span><span class="pun">.</span><span class="pln">statics</span><span class="pun">.</span><span class="pln">findByName </span><span class="pun">=</span> <span class="kwd">function</span><span class="pun">(</span><span class="pln">name</span><span class="pun">,</span><span class="pln">cb</span><span class="pun">){</span><br>    <span class="kwd">this</span><span class="pun">.</span><span class="pln">find</span><span class="pun">({</span><span class="pln">name</span><span class="pun">:</span><span class="kwd">new</span> <span class="typ">RegExp</span><span class="pun">(</span><span class="pln">name</span><span class="pun">,</span><span class="str">‘i’</span><span class="pun">),</span><span class="pln">cb</span><span class="pun">});</span><br>  <span class="pun">}</span><br>  <span class="kwd">var</span> <span class="typ">PersonModel</span> <span class="pun">=</span><span class="pln"> mongoose</span><span class="pun">.</span><span class="pln">model</span><span class="pun">(</span><span class="str">‘Person’</span><span class="pun">,</span><span class="typ">PersonSchema</span><span class="pun">);</span><br>  <span class="typ">PersonModel</span><span class="pun">.</span><span class="pln">findByName</span><span class="pun">(</span><span class="str">‘krouky’</span><span class="pun">,</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln">persons</span><span class="pun">){</span><br>    <span class="com">//找到所有名字叫krouky的人</span><br>  <span class="pun">});</span></code></pre></p>
<p>####2.3 索引</p>
<p>索引或者复合索引能让搜索更加高效，默认索引就是主键索引<code>ObjectId</code>，属性名为<code>_id</code>， <em>索引会作为一个专题来讲解</em></p>
<p>####2.4 虚拟属性</p>
<p><code>Schema</code>中如果定义了虚拟属性，那么该属性将不写入数据库，例如：</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">var</span> <span class="typ">PersonSchema</span> <span class="pun">=</span> <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">({</span><span class="pln"><br>      name</span><span class="pun">:{</span><span class="pln"><br>        first</span><span class="pun">:</span><span class="typ">String</span><span class="pun">,</span><br>        <span class="kwd">last</span><span class="pun">:</span><span class="typ">String</span><br>      <span class="pun">}</span><br>    <span class="pun">});</span><br>    <span class="kwd">var</span> <span class="typ">PersonModel</span> <span class="pun">=</span><span class="pln"> mongoose</span><span class="pun">.</span><span class="pln">model</span><span class="pun">(</span><span class="str">‘Person’</span><span class="pun">,</span><span class="typ">PersonSchema</span><span class="pun">);</span><br>    <span class="kwd">var</span><span class="pln"> krouky </span><span class="pun">=</span> <span class="kwd">new</span> <span class="typ">PersonModel</span><span class="pun">({</span><span class="pln"><br>      name</span><span class="pun">:{</span><span class="pln">first</span><span class="pun">:</span><span class="str">‘krouky’</span><span class="pun">,</span><span class="kwd">last</span><span class="pun">:</span><span class="str">‘han’</span><span class="pun">}</span><br>    <span class="pun">});</span></code></pre><br>如果每次想使用全名就得这样</p>
<p><pre class="prettyprint language-javascript"><code><span class="pln">    console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">krouky</span><span class="pun">.</span><span class="pln">name</span><span class="pun">.</span><span class="pln">first </span><span class="pun">+</span> <span class="str">‘ ‘</span> <span class="pun">+</span><span class="pln"> krouky</span><span class="pun">.</span><span class="pln">name</span><span class="pun">.</span><span class="kwd">last</span><span class="pun">);</span></code></pre><br>显然这是很麻烦的，我们可以定义<code>虚拟属性</code>：</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="typ">PersonSchema</span><span class="pun">.</span><span class="kwd">virtual</span><span class="pun">(</span><span class="str">‘name.full’</span><span class="pun">).</span><span class="kwd">get</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(){</span><br>      <span class="kwd">return</span> <span class="kwd">this</span><span class="pun">.</span><span class="pln">name</span><span class="pun">.</span><span class="pln">first </span><span class="pun">+</span> <span class="str">‘ ‘</span> <span class="pun">+</span> <span class="kwd">this</span><span class="pun">.</span><span class="pln">name</span><span class="pun">.</span><span class="kwd">last</span><span class="pun">;</span><br>    <span class="pun">});</span></code></pre><br>那么就能用<code>krouky.name.full</code>来调用全名了，反之如果知道full，也可以反解<code>first</code>和<code>last</code>属性</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="typ">PersonSchema</span><span class="pun">.</span><span class="kwd">virtual</span><span class="pun">(</span><span class="str">‘name.full’</span><span class="pun">).</span><span class="kwd">set</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">name</span><span class="pun">){</span><br>      <span class="kwd">var</span><span class="pln"> split </span><span class="pun">=</span><span class="pln"> name</span><span class="pun">.</span><span class="pln">split</span><span class="pun">(</span><span class="str">‘ ‘</span><span class="pun">);</span><br>      <span class="kwd">this</span><span class="pun">.</span><span class="pln">name</span><span class="pun">.</span><span class="pln">first </span><span class="pun">=</span><span class="pln"> split</span><span class="pun">[</span><span class="lit">0</span><span class="pun">];</span><br>      <span class="kwd">this</span><span class="pun">.</span><span class="pln">name</span><span class="pun">.</span><span class="kwd">last</span> <span class="pun">=</span><span class="pln"> split</span><span class="pun">[</span><span class="lit">1</span><span class="pun">];</span><br>    <span class="pun">});</span><br>    <span class="kwd">var</span> <span class="typ">PersonModel</span> <span class="pun">=</span><span class="pln"> mongoose</span><span class="pun">.</span><span class="pln">model</span><span class="pun">(</span><span class="str">‘Person’</span><span class="pun">,</span><span class="typ">PersonSchema</span><span class="pun">);</span><br>    <span class="kwd">var</span><span class="pln"> krouky </span><span class="pun">=</span> <span class="kwd">new</span> <span class="typ">PersonModel</span><span class="pun">({});</span><span class="pln"><br>    krouky</span><span class="pun">.</span><span class="pln">name</span><span class="pun">.</span><span class="pln">full </span><span class="pun">=</span> <span class="str">‘krouky han’</span><span class="pun">;</span><span class="com">//会被自动分解</span><span class="pln"><br>    console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">krouky</span><span class="pun">.</span><span class="pln">name</span><span class="pun">.</span><span class="pln">first</span><span class="pun">);</span><span class="com">//krouky</span></code></pre></p>
<p>####2.5 配置项</p>
<p>在使用<code>new Schema(config)</code>时，我们可以追加一个参数<code>options</code>来配置<code>Schema</code>的配置，形如：</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">var</span> <span class="typ">ExampleSchema</span> <span class="pun">=</span> <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">(</span><span class="pln">config</span><span class="pun">,</span><span class="pln">options</span><span class="pun">);</span></code></pre><br>或者使用</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">var</span> <span class="typ">ExampleSchema</span> <span class="pun">=</span> <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">(</span><span class="pln">config</span><span class="pun">);</span><br>    <span class="typ">ExampleSchema</span><span class="pun">.</span><span class="kwd">set</span><span class="pun">(</span><span class="pln">option</span><span class="pun">,</span><span class="pln">value</span><span class="pun">);</span></code></pre><br>可供配置项有：<code>safe</code>、<code>strict</code>、<code>capped</code>、<code>versionKey</code>、<code>autoIndex</code></p>
<p>#####2.5.1 safe——安全属性（默认安全）</p>
<p>一般可做如下配置：</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">({…},{</span><span class="pln">safe</span><span class="pun">:</span><span class="kwd">true</span><span class="pun">});</span></code></pre><br>当然我们也可以这样</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">({…},{</span><span class="pln">safe</span><span class="pun">:{</span><span class="pln">j</span><span class="pun">:</span><span class="lit">1</span><span class="pun">,</span><span class="pln">w</span><span class="pun">:</span><span class="lit">2</span><span class="pun">,</span><span class="pln">wtimeout</span><span class="pun">:</span><span class="lit">10000</span><span class="pun">}});</span></code></pre><br><code>j</code>表示做1份日志，<code>w</code>表示做2个副本（尚不明确），超时时间10秒</p>
<p>#####2.5.2 strict——严格配置（默认启用）</p>
<p>确保<code>Entity</code>的值存入数据库前会被自动验证，如果你没有充足的理由，请不要停用，例子：</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">var</span> <span class="typ">ThingSchema</span> <span class="pun">=</span> <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">({</span><span class="pln">a</span><span class="pun">:</span><span class="typ">String</span><span class="pun">});</span><br>    <span class="kwd">var</span> <span class="typ">ThingModel</span> <span class="pun">=</span><span class="pln"> db</span><span class="pun">.</span><span class="pln">model</span><span class="pun">(</span><span class="str">‘Thing’</span><span class="pun">,</span><span class="typ">SchemaSchema</span><span class="pun">);</span><br>    <span class="kwd">var</span><span class="pln"> thing </span><span class="pun">=</span> <span class="kwd">new</span> <span class="typ">Thing</span><span class="pun">({</span><span class="pln">iAmNotInTheThingSchema</span><span class="pun">:</span><span class="kwd">true</span><span class="pun">});</span><span class="pln"><br>    thing</span><span class="pun">.</span><span class="pln">save</span><span class="pun">();</span><span class="com">//iAmNotInTheThingSchema这个属性将无法被存储</span></code></pre><br>如果取消严格选项，<code>iAmNotInTheThingSchema</code>将会被存入数据库</p>
<p>该选项也可以在构造实例时使用，例如：</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">var</span> <span class="typ">ThingModel</span> <span class="pun">=</span><span class="pln"> db</span><span class="pun">.</span><span class="pln">model</span><span class="pun">(</span><span class="str">‘Thing’</span><span class="pun">);</span><br>    <span class="kwd">var</span><span class="pln"> thing1 </span><span class="pun">=</span> <span class="kwd">new</span> <span class="typ">ThingModel</span><span class="pun">(</span><span class="pln">doc</span><span class="pun">,</span><span class="kwd">true</span><span class="pun">);</span>  <span class="com">//启用严格</span><br>    <span class="kwd">var</span><span class="pln"> thing2 </span><span class="pun">=</span> <span class="kwd">new</span> <span class="typ">ThingModel</span><span class="pun">(</span><span class="pln">doc</span><span class="pun">,</span><span class="kwd">false</span><span class="pun">);</span> <span class="com">//禁用严格</span></code></pre><br><strong>注意：</strong></p>
<p><code>strict</code>也可以设置为<code>throw</code>，表示出现问题将会抛出错误</p>
<p>#####2.5.3 shardKey</p>
<p>需要<code>mongodb</code>做分布式，才会使用该属性</p>
<p>#####2.5.4 capped——上限设置</p>
<p>如果有数据库的批量操作，该属性能限制一次操作的量，例如：</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">({…},{</span><span class="pln">capped</span><span class="pun">:</span><span class="lit">1024</span><span class="pun">});</span>  <span class="com">//一次操作上线1024条数据</span></code></pre><br>当然该参数也可是JSON对象，包含size、max、autiIndexId属性</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">({…},{</span><span class="pln">capped</span><span class="pun">:{</span><span class="pln">size</span><span class="pun">:</span><span class="lit">1024</span><span class="pun">,</span><span class="pln">max</span><span class="pun">:</span><span class="lit">100</span><span class="pun">,</span><span class="pln">autoIndexId</span><span class="pun">:</span><span class="kwd">true</span><span class="pun">}});</span></code></pre></p>
<p>#####2.5.5 versionKey——版本锁</p>
<p>版本锁是<code>Mongoose</code>默认配置（__v属性）的，如果你想自己定制，如下：</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">({…},{</span><span class="pln">versionKey</span><span class="pun">:</span><span class="str">‘<strong>someElse’</strong></span><span class="pun">});</span></code></pre><br>此时存入数据库的版本锁就不是<code>v</code>属性，而是<code>__someElse</code>，相当于是给版本锁取名字。</p>
<p>具体怎么存入都是由<code>Mongoose</code>和<code>MongoDB</code>自己决定，当然，这个属性你也可以去除</p>
<p><pre class="prettyprint language-javascript"><code>  <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">({…},{</span><span class="pln">versionKey</span><span class="pun">:</span><span class="kwd">false</span><span class="pun">});</span></code></pre><br>除非你知道你在做什么，并且你知道这样做的后果</p>
<p>#####2.5.6 autoIndex——自动索引</p>
<p><em>该内容将在索引章节单独讲解</em></p>
<p>###3. Documents</p>
<p><code>Document</code>是与<code>MongoDB</code>文档一一对应的模型，<code>Document</code>可等同于<code>Entity</code>，具有属性和操作性</p>
<p><strong>注意：</strong></p>
<p><code>Document</code>的`CRUD都必须经过严格验证的，参看<strong>2.5.2 Schema的strict严格配置</strong></p>
<p>####3.1 查询</p>
<p>查询内容过多，专题讲解</p>
<p>####3.2 更新</p>
<p>有许多方式来更新文件，以下是常用的传统方式：</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="typ">PersonModel</span><span class="pun">.</span><span class="pln">findById</span><span class="pun">(</span><span class="pln">id</span><span class="pun">,</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln">person</span><span class="pun">){</span><span class="pln"><br>      person</span><span class="pun">.</span><span class="pln">name </span><span class="pun">=</span> <span class="str">‘MDragon’</span><span class="pun">;</span><span class="pln"><br>      person</span><span class="pun">.</span><span class="pln">save</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">){});</span><br>    <span class="pun">});</span></code></pre><br>这里，利用<code>Model</code>模型查询到了<code>person</code>对象，该对象属于<code>Entity</code>，可以有<code>save操作，如果使用</code>Model`操作，需注意：</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="typ">PersonModel</span><span class="pun">.</span><span class="pln">findById</span><span class="pun">(</span><span class="pln">id</span><span class="pun">,</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln">person</span><span class="pun">){</span><span class="pln"><br>      person</span><span class="pun">.</span><span class="pln">name </span><span class="pun">=</span> <span class="str">‘MDragon’</span><span class="pun">;</span><br>      <span class="kwd">var</span><span class="pln"> _id </span><span class="pun">=</span><span class="pln"> person</span><span class="pun">.</span><span class="pln">_id</span><span class="pun">;</span> <span class="com">//需要取出主键_id</span><br>      <span class="kwd">delete</span><span class="pln"> person</span><span class="pun">.</span><span class="pln">_id</span><span class="pun">;</span>    <span class="com">//再将其删除</span><br>      <span class="typ">PersonModel</span><span class="pun">.</span><span class="pln">update</span><span class="pun">({</span><span class="pln">_id</span><span class="pun">:</span><span class="pln">_id</span><span class="pun">},</span><span class="pln">person</span><span class="pun">,</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">){});</span><br>      <span class="com">//此时才能用Model操作，否则报错</span><br>    <span class="pun">});</span></code></pre><br><code>update</code>第一个参数是查询条件，第二个参数是更新的对象，但不能更新主键，这就是为什么要删除主键的原因。</p>
<p>当然这样的更新很麻烦，可以使用<code>$set</code>属性来配置，这样也不用先查询，如果更新的数据比较少，可用性还是很好的：</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="typ">PersonModel</span><span class="pun">.</span><span class="pln">update</span><span class="pun">({</span><span class="pln">_id</span><span class="pun">:</span><span class="pln">_id</span><span class="pun">},{</span><span class="pln">$set</span><span class="pun">:{</span><span class="pln">name</span><span class="pun">:</span><span class="str">‘MDragon’</span><span class="pun">}},</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">){});</span></code></pre><br>需要注意，<code>Document</code>的<code>CRUD</code>操作都是异步执行，<code>callback</code>第一个参数必须是<code>err</code>，而第二个参数各个方法不一样，<code>update</code>的<code>callback</code>第二个参数是更新的数量，如果要返回更新后的对象，则要使用如下方法</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="typ">Person</span><span class="pun">.</span><span class="pln">findByIdAndUpdate</span><span class="pun">(</span><span class="pln">_id</span><span class="pun">,{</span><span class="pln">$set</span><span class="pun">:{</span><span class="pln">name</span><span class="pun">:</span><span class="str">‘MDragon’</span><span class="pun">}},</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln">person</span><span class="pun">){</span><span class="pln"><br>      console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">person</span><span class="pun">.</span><span class="pln">name</span><span class="pun">);</span> <span class="com">//MDragon</span><br>    <span class="pun">});</span></code></pre><br>类似的方法还有<code>findByIdAndRemove</code>，如同名字，只能根据id查询并作<code>update</code>/<code>remove</code>操作，操作的数据仅一条</p>
<p>####3.3 新增</p>
<p>如果是<code>Entity</code>，使用<code>save</code>方法，如果是<code>Model</code>，使用<code>create</code>方法</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="com">//使用Entity来增加一条数据</span><br>    <span class="kwd">var</span><span class="pln"> krouky </span><span class="pun">=</span> <span class="kwd">new</span> <span class="typ">PersonModel</span><span class="pun">({</span><span class="pln">name</span><span class="pun">:</span><span class="str">‘krouky’</span><span class="pun">});</span><span class="pln"><br>    krouky</span><span class="pun">.</span><span class="pln">save</span><span class="pun">(</span><span class="pln">callback</span><span class="pun">);</span><br>    <span class="com">//使用Model来增加一条数据</span><br>    <span class="kwd">var</span> <span class="typ">MDragon</span> <span class="pun">=</span> <span class="pun">{</span><span class="pln">name</span><span class="pun">:</span><span class="str">‘MDragon’</span><span class="pun">};</span><br>    <span class="typ">PersonModel</span><span class="pun">.</span><span class="pln">create</span><span class="pun">(</span><span class="typ">MDragon</span><span class="pun">,</span><span class="pln">callback</span><span class="pun">);</span></code></pre><br>两种新增方法区别在于，如果使用<code>Model</code>新增时，传入的对象只能是纯净的<code>JSON</code>对象，不能是由<code>Model</code>创建的实体，原因是：由<code>Model</code>创建的实体<code>krouky</code>虽然打印是只有<code>{name:’krouky’}</code>，但是<code>krouky</code>属于<code>Entity</code>，包含有<code>Schema</code>属性和<code>Model</code>数据库行为模型。如果是使用<code>Model</code>创建的对象，传入时一定会将隐藏属性也存入数据库，虽然<code>3.x</code>追加了默认严格属性，但也不必要增加操作的报错</p>
<p>####3.4 删除</p>
<p>和新增一样，删除也有2种方式，但<code>Entity</code>和<code>Model</code>都使用<code>remove</code>方法</p>
<p>###4.Sub Docs</p>
<p>如同<code>SQL</code>数据库中2张表有主外关系，<code>Mongoose</code>将2个<code>Document</code>的嵌套叫做<code>Sub-Docs</code>（子文档）</p>
<p>简单的说就是一个<code>Document</code>嵌套另外一个<code>Document</code>或者<code>Documents</code>:</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">var</span> <span class="typ">ChildSchema1</span> <span class="pun">=</span> <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">({</span><span class="pln">name</span><span class="pun">:</span><span class="typ">String</span><span class="pun">});</span><br>    <span class="kwd">var</span> <span class="typ">ChildSchema2</span> <span class="pun">=</span> <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">({</span><span class="pln">name</span><span class="pun">:</span><span class="typ">String</span><span class="pun">});</span><br>    <span class="kwd">var</span> <span class="typ">ParentSchema</span> <span class="pun">=</span> <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">({</span><span class="pln"><br>      children1</span><span class="pun">:</span><span class="typ">ChildSchema1</span><span class="pun">,</span>   <span class="com">//嵌套Document</span><span class="pln"><br>      children2</span><span class="pun">:[</span><span class="typ">ChildSchema2</span><span class="pun">]</span>  <span class="com">//嵌套Documents</span><br>    <span class="pun">});</span></code></pre><br><code>Sub-Docs</code>享受和<code>Documents</code>一样的操作，但是<code>Sub-Docs</code>的操作都由父类去执行</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">var</span> <span class="typ">ParentModel</span> <span class="pun">=</span><span class="pln"> db</span><span class="pun">.</span><span class="pln">model</span><span class="pun">(</span><span class="str">‘Parent’</span><span class="pun">,</span><span class="pln">parentSchema</span><span class="pun">);</span><br>    <span class="kwd">var</span><span class="pln"> parent </span><span class="pun">=</span> <span class="kwd">new</span> <span class="typ">ParentModel</span><span class="pun">({</span><span class="pln"><br>      children2</span><span class="pun">:[{</span><span class="pln">name</span><span class="pun">:</span><span class="str">‘c1’</span><span class="pun">},{</span><span class="pln">name</span><span class="pun">:</span><span class="str">‘c2’</span><span class="pun">}]</span><br>    <span class="pun">});</span><span class="pln"><br>    parent</span><span class="pun">.</span><span class="pln">children2</span><span class="pun">[</span><span class="lit">0</span><span class="pun">].</span><span class="pln">name </span><span class="pun">=</span> <span class="str">‘d’</span><span class="pun">;</span><span class="pln"><br>    parent</span><span class="pun">.</span><span class="pln">save</span><span class="pun">(</span><span class="pln">callback</span><span class="pun">);</span></code></pre><br><code>parent</code>在执行保存时，由于包含<code>children2</code>，他是一个数据库模型对象，因此会先保存<code>chilren2[0]</code>和<code>chilren2[1]</code>。</p>
<p>如果子文档在更新时出现错误，将直接报在父类文档中，可以这样处理：</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="typ">ChildrenSchema</span><span class="pun">.</span><span class="pln">pre</span><span class="pun">(</span><span class="str">‘save’</span><span class="pun">,</span><span class="kwd">function</span><span class="pun">(</span><span class="kwd">next</span><span class="pun">){</span><br>      <span class="kwd">if</span><span class="pun">(</span><span class="str">‘x’</span> <span class="pun">===</span> <span class="kwd">this</span><span class="pun">.</span><span class="pln">name</span><span class="pun">)</span> <span class="kwd">return</span> <span class="kwd">next</span><span class="pun">(</span><span class="kwd">new</span> <span class="typ">Error</span><span class="pun">(</span><span class="str">‘#err:not-x’</span><span class="pun">));</span><br>      <span class="kwd">next</span><span class="pun">();</span><br>    <span class="pun">});</span><br>    <span class="kwd">var</span><span class="pln"> parent </span><span class="pun">=</span> <span class="kwd">new</span> <span class="typ">ParentModel</span><span class="pun">({</span><span class="pln">children1</span><span class="pun">:{</span><span class="pln">name</span><span class="pun">:</span><span class="str">‘not-x’</span><span class="pun">}});</span><span class="pln"><br>    parent</span><span class="pun">.</span><span class="pln">save</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">){</span><span class="pln"><br>      console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">err</span><span class="pun">.</span><span class="pln">message</span><span class="pun">);</span> <span class="com">//#err:not-x</span><br>    <span class="pun">});</span></code></pre></p>
<p>####4.1 查询子文档</p>
<p>如果<code>children</code>是<code>parent</code>的子文档，可以通过如下方法查询到<code>children</code></p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">var</span><span class="pln"> child </span><span class="pun">=</span><span class="pln"> parent</span><span class="pun">.</span><span class="pln">children</span><span class="pun">.</span><span class="pln">id</span><span class="pun">(</span><span class="pln">id</span><span class="pun">);</span></code></pre></p>
<p>####4.2 新增、删除、更新</p>
<p>子文档是父文档的一个属性，因此按照属性的操作即可，不同的是在新增父类的时候，子文档是会被先加入进去的。</p>
<p>如果<code>ChildrenSchema</code>是临时的一个子文档，不作为数据库映射集合，可以这样：</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">var</span> <span class="typ">ParentSchema</span> <span class="pun">=</span> <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">({</span><span class="pln"><br>      children</span><span class="pun">:{</span><span class="pln"><br>        name</span><span class="pun">:</span><span class="typ">String</span><br>      <span class="pun">}</span><br>    <span class="pun">});</span><br>    <span class="com">//其实就是匿名混合模式</span></code></pre></p>
<p>###5.Model</p>
<p>####5.1 什么是Model</p>
<p><code>Model</code>模型，是经过<code>Schema</code>构造来的，除了<code>Schema</code>定义的数据库骨架以外，还具有数据库行为模型，他相当于管理数据库属性、行为的类</p>
<p>####5.2 如何创建Model</p>
<p>你必须通过<code>Schema</code>来创建，如下：</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="com">//先创建Schema</span><br>    <span class="kwd">var</span> <span class="typ">TankSchema</span> <span class="pun">=</span> <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">({</span><span class="pln"><br>      name</span><span class="pun">:</span><span class="str">‘String’</span><span class="pun">,</span><span class="pln"><br>      size</span><span class="pun">:</span><span class="str">‘String’</span><br>    <span class="pun">});</span><br>    <span class="com">//通过Schema创建Model</span><br>    <span class="kwd">var</span> <span class="typ">TankModel</span> <span class="pun">=</span><span class="pln"> mongoose</span><span class="pun">.</span><span class="pln">model</span><span class="pun">(</span><span class="str">‘Tank’</span><span class="pun">,</span><span class="typ">TankSchema</span><span class="pun">);</span></code></pre></p>
<p>####5.2 操作Model</p>
<p>该模型就能直接拿来操作，具体查看<code>API</code>，例如：</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">var</span><span class="pln"> tank </span><span class="pun">=</span> <span class="pun">{</span><span class="str">‘something’</span><span class="pun">,</span><span class="pln">size</span><span class="pun">:</span><span class="str">‘small’</span><span class="pun">};</span><br>    <span class="typ">TankModel</span><span class="pun">.</span><span class="pln">create</span><span class="pun">(</span><span class="pln">tank</span><span class="pun">);</span></code></pre><br><strong>注意：</strong></p>
<p>你可以使用<code>Model</code>来创建<code>Entity</code>，<code>Entity</code>实体是一个特有<code>Model</code>具体对象，但是他并不具备<code>Model</code>的方法，只能用自己的方法。</p>
<p><pre class="prettyprint language-javascript"><code>  <span class="com">//通过Model创建Entity</span><br>  <span class="kwd">var</span><span class="pln"> tankEntity </span><span class="pun">=</span> <span class="kwd">new</span> <span class="typ">TankModel</span><span class="pun">(</span><span class="str">‘someother’</span><span class="pun">,</span><span class="str">‘size:big’</span><span class="pun">);</span><span class="pln"><br>  tankEntity</span><span class="pun">.</span><span class="pln">save</span><span class="pun">();</span></code></pre></p>
<p>###6.Query</p>
<p>查询是数据库中运用最多也是最麻烦的地方，这里对<code>Query</code>解读的并不完善，仅仅是自己的一点领悟而已。</p>
<p>####6.1 查询的方式</p>
<p>通常有2种查询方式，一种是<code>直接查询</code>，一种是<code>链式查询</code>（2种查询都是自己命名的）</p>
<p>#####6.1.1 直接查询</p>
<p>在查询时带有回调函数的，称之为直接查询，查询的条件往往通过<code>API</code>来设定，例如：</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="typ">PersonModel</span><span class="pun">.</span><span class="pln">findOne</span><span class="pun">({</span><span class="str">‘name.last’</span><span class="pun">:</span><span class="str">‘dragon’</span><span class="pun">},</span><span class="str">‘some select’</span><span class="pun">,</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln">person</span><span class="pun">){</span><br>      <span class="com">//如果err==null，则person就能取到数据</span><br>    <span class="pun">});</span></code></pre><br>具体的查询参数，请查询<code>API</code></p>
<p>#####6.1.2 链式查询</p>
<p>在查询时候，不带回调，而查询条件通过<code>API</code>函数来制定，例如：</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">var</span><span class="pln"> query </span><span class="pun">=</span> <span class="typ">PersonModel</span><span class="pun">.</span><span class="pln">findOne</span><span class="pun">({</span><span class="str">‘name.last’</span><span class="pun">:</span><span class="str">‘dragon’</span><span class="pun">});</span><span class="pln"><br>    query</span><span class="pun">.</span><span class="kwd">select</span><span class="pun">(</span><span class="str">‘some select’</span><span class="pun">);</span><span class="pln"><br>    query</span><span class="pun">.</span><span class="kwd">exec</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln">pserson</span><span class="pun">){</span><br>    <span class="com">//如果err==null，则person就能取到数据</span><br>  <span class="pun">});</span></code></pre><br>这种方式相对直接查询，分的比较明细，如果不带<code>callback</code>，则返回<code>query</code>，<code>query</code>没有执行的预编译查询语句，该<code>query</code>对象执行的方法都将返回自己，只有在执行<code>exec</code>方法时才执行查询，而且必须有回调。</p>
<p>因为<code>query</code>的操作始终返回自身，我们可以采用更形象的链式写法</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="typ">Person</span><br>      <span class="pun">.</span><span class="pln">find</span><span class="pun">({</span><span class="pln"> occupation</span><span class="pun">:</span> <span class="str">/host/</span> <span class="pun">})</span><br>      <span class="pun">.</span><span class="kwd">where</span><span class="pun">(</span><span class="str">‘name.last’</span><span class="pun">).</span><span class="pln">equals</span><span class="pun">(</span><span class="str">‘Ghost’</span><span class="pun">)</span><br>      <span class="pun">.</span><span class="kwd">where</span><span class="pun">(</span><span class="str">‘age’</span><span class="pun">).</span><span class="pln">gt</span><span class="pun">(</span><span class="lit">17</span><span class="pun">).</span><span class="pln">lt</span><span class="pun">(</span><span class="lit">66</span><span class="pun">)</span><br>      <span class="pun">.</span><span class="kwd">where</span><span class="pun">(</span><span class="str">‘likes’</span><span class="pun">).</span><span class="kwd">in</span><span class="pun">([</span><span class="str">‘vaporizing’</span><span class="pun">,</span> <span class="str">‘talking’</span><span class="pun">])</span><br>      <span class="pun">.</span><span class="pln">limit</span><span class="pun">(</span><span class="lit">10</span><span class="pun">)</span><br>      <span class="pun">.</span><span class="pln">sort</span><span class="pun">(</span><span class="str">‘-occupation’</span><span class="pun">)</span><br>      <span class="pun">.</span><span class="kwd">select</span><span class="pun">(</span><span class="str">‘name occupation’</span><span class="pun">)</span><br>      <span class="pun">.</span><span class="kwd">exec</span><span class="pun">(</span><span class="pln">callback</span><span class="pun">);</span></code></pre></p>
<p>###7.Validation</p>
<p>数据的存储是需要验证的，不是什么数据都能往数据库里丢或者显示到客户端的，数据的验证需要记住以下规则：</p>
<p><ul><br>    <li>验证始终定义在<code>SchemaType</code>中</li><br>    <li>验证是一个内部中间件</li><br>    <li>验证是在一个<code>Document</code>被保存时默认启用的，除非你关闭验证</li><br>    <li>验证是异步递归的，如果你的<code>SubDoc</code>验证失败，<code>Document</code>也将无法保存</li><br>    <li>验证并不关心错误类型，而通过<code>ValidationError</code>这个对象可以访问</li><br></ul></p>
<p>####7.1 验证器</p>
<p><ol><br>    <li><code>required</code> 非空验证</li><br>    <li><code>min</code>/<code>max</code> 范围验证（边值验证）</li><br>    <li><code>enum</code>/<code>match</code> 枚举验证/匹配验证</li><br>    <li><code>validate</code> 自定义验证规则</li><br></ol><br>以下是综合案例：</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">var</span> <span class="typ">PersonSchema</span> <span class="pun">=</span> <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">({</span><span class="pln"><br>      name</span><span class="pun">:{</span><span class="pln"><br>        type</span><span class="pun">:</span><span class="str">‘String’</span><span class="pun">,</span><span class="pln"><br>        required</span><span class="pun">:</span><span class="kwd">true</span> <span class="com">//姓名非空</span><br>      <span class="pun">},</span><span class="pln"><br>      age</span><span class="pun">:{</span><span class="pln"><br>        type</span><span class="pun">:</span><span class="str">‘Nunmer’</span><span class="pun">,</span><span class="pln"><br>        min</span><span class="pun">:</span><span class="lit">18</span><span class="pun">,</span>       <span class="com">//年龄最小18</span><span class="pln"><br>        max</span><span class="pun">:</span><span class="lit">120</span>     <span class="com">//年龄最大120</span><br>      <span class="pun">},</span><span class="pln"><br>      city</span><span class="pun">:{</span><span class="pln"><br>        type</span><span class="pun">:</span><span class="str">‘String’</span><span class="pun">,</span><br>        <span class="kwd">enum</span><span class="pun">:[</span><span class="str">‘北京’</span><span class="pun">,</span><span class="str">‘上海’</span><span class="pun">]</span>  <span class="com">//只能是北京、上海人</span><br>      <span class="pun">},</span><span class="pln"><br>      other</span><span class="pun">:{</span><span class="pln"><br>        type</span><span class="pun">:</span><span class="str">‘String’</span><span class="pun">,</span><span class="pln"><br>        validate</span><span class="pun">:[</span><span class="pln">validator</span><span class="pun">,</span><span class="pln">err</span><span class="pun">]</span>  <span class="com">//validator是一个验证函数，err是验证失败的错误信息</span><br>      <span class="pun">}</span><br>    <span class="pun">});</span></code></pre></p>
<p>####7.2 验证失败</p>
<p>如果验证失败，则会返回<code>err</code>信息，<code>err</code>是一个对象该对象属性如下</p>
<p><pre class="prettyprint language-javascript"><code><span class="pln">    err</span><span class="pun">.</span><span class="pln">errors                </span><span class="com">//错误集合（对象）</span><span class="pln"><br>    err</span><span class="pun">.</span><span class="pln">errors</span><span class="pun">.</span><span class="pln">color          </span><span class="com">//错误属性(Schema的color属性)</span><span class="pln"><br>    err</span><span class="pun">.</span><span class="pln">errors</span><span class="pun">.</span><span class="pln">color</span><span class="pun">.</span><span class="pln">message  </span><span class="com">//错误属性信息</span><span class="pln"><br>    err</span><span class="pun">.</span><span class="pln">errors</span><span class="pun">.</span><span class="pln">path             </span><span class="com">//错误属性路径</span><span class="pln"><br>    err</span><span class="pun">.</span><span class="pln">errors</span><span class="pun">.</span><span class="pln">type             </span><span class="com">//错误类型</span><span class="pln"><br>    err</span><span class="pun">.</span><span class="pln">name                </span><span class="com">//错误名称</span><span class="pln"><br>    err</span><span class="pun">.</span><span class="pln">message                 </span><span class="com">//错误消息</span></code></pre><br>一旦验证失败，<code>Model</code>和<code>Entity</code>都将具有和<code>err</code>一样的<code>errors</code>属性</p>
<p>###8.Middleware中间件</p>
<p>####8.1 什么是中间件</p>
<p>中间件是一种控制函数，类似插件，能控制流程中的<code>init</code>、validate<code>、</code>save<code>、</code>remove`方法</p>
<p>####8.2 中间件的分类</p>
<p>中间件分为两类</p>
<p>#####8.2.1 Serial串行</p>
<p>串行使用<code>pre</code>方法，执行下一个方法使用<code>next</code>调用</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">var</span><span class="pln"> schema </span><span class="pun">=</span> <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">(…);</span><span class="pln"><br>    schema</span><span class="pun">.</span><span class="pln">pre</span><span class="pun">(</span><span class="str">‘save’</span><span class="pun">,</span><span class="kwd">function</span><span class="pun">(</span><span class="kwd">next</span><span class="pun">){</span><br>      <span class="com">//做点什么</span><br>      <span class="kwd">next</span><span class="pun">();</span><br>    <span class="pun">});</span></code></pre></p>
<p>#####8.2.2 Parallel并行</p>
<p>并行提供更细粒度的操作</p>
<p><pre class="prettyprint language-javascript"><code>    <span class="kwd">var</span><span class="pln"> schema </span><span class="pun">=</span> <span class="kwd">new</span> <span class="typ">Schema</span><span class="pun">(…);</span><span class="pln"><br>    schema</span><span class="pun">.</span><span class="pln">pre</span><span class="pun">(</span><span class="str">‘save’</span><span class="pun">,</span><span class="kwd">function</span><span class="pun">(</span><span class="kwd">next</span><span class="pun">,</span><span class="kwd">done</span><span class="pun">){</span><br>      <span class="com">//下一个要执行的中间件并行执行</span><br>      <span class="kwd">next</span><span class="pun">();</span><span class="pln"><br>      doAsync</span><span class="pun">(</span><span class="kwd">done</span><span class="pun">);</span><br>    <span class="pun">});</span></code></pre></p>
<p>####8.3 中间件特点</p>
<p>一旦定义了中间件，就会在全部中间件执行完后执行其他操作，使用中间件可以雾化模型，避免异步操作的层层迭代嵌套</p>
<p>####8.4 使用范畴</p>
<p><ol><br>    <li>复杂的验证</li><br>    <li>删除有主外关联的<code>doc</code></li><br>    <li>异步默认</li><br>    <li>某个特定动作触发异步任务，例如触发自定义事件和通知</li><br></ol><br>例如，可以用来做自定义错误处理</p>
<p><pre class="prettyprint language-javascript"><code><span class="pln">    schema</span><span class="pun">.</span><span class="pln">pre</span><span class="pun">(</span><span class="str">‘save’</span><span class="pun">,</span><span class="kwd">function</span><span class="pun">(</span><span class="kwd">next</span><span class="pun">){</span><br>      <span class="kwd">var</span><span class="pln"> err </span><span class="pun">=</span> <span class="kwd">new</span> <span class="typ">Eerror</span><span class="pun">(</span><span class="str">‘some err’</span><span class="pun">);</span><br>      <span class="kwd">next</span><span class="pun">(</span><span class="pln">err</span><span class="pun">);</span><br>    <span class="pun">});</span><span class="pln"><br>    entity</span><span class="pun">.</span><span class="pln">save</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">){</span><span class="pln"><br>      console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">err</span><span class="pun">.</span><span class="pln">message</span><span class="pun">);</span> <span class="com">//some err</span><br>    <span class="pun">});</span></code></pre></p>
<p><pre class="prettyprint language-js"><code><span class="com">// mongoose 链接</span> <span class="kwd">var</span><span class="pln"> mongoose </span><span class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span class="str">‘mongoose’</span><span class="pun">);</span> <span class="kwd">var</span><span class="pln"> db </span><span class="pun">=</span><span class="pln"> mongoose</span><span class="pun">.</span><span class="pln">createConnection</span><span class="pun">(</span><span class="str">‘mongodb://127.0.0.1:27017/NodeJS’</span><span class="pun">);</span> </code></pre></p>
<p><pre class="prettyprint language-js"><code><span class="com">// 链接错误</span><span class="pln"><br>db</span><span class="pun">.</span><span class="pln">on</span><span class="pun">(</span><span class="str">‘error’</span><span class="pun">,</span> <span class="kwd">function</span><span class="pun">(</span><span class="pln">error</span><span class="pun">)</span> <span class="pun">{</span><span class="pln"><br>    console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">error</span><span class="pun">);</span><br><span class="pun">});</span></code></pre></p>
<p><pre class="prettyprint language-js"><code><span class="com">// Schema 结构</span><br><span class="kwd">var</span><span class="pln"> mongooseSchema </span><span class="pun">=</span> <span class="kwd">new</span><span class="pln"> mongoose</span><span class="pun">.</span><span class="typ">Schema</span><span class="pun">({</span><span class="pln"><br>    username </span><span class="pun">:</span> <span class="pun">{</span><span class="pln">type </span><span class="pun">:</span> <span class="typ">String</span><span class="pun">,</span> <span class="kwd">default</span> <span class="pun">:</span> <span class="str">‘匿名用户’</span><span class="pun">},</span><span class="pln"><br>    title    </span><span class="pun">:</span> <span class="pun">{</span><span class="pln">type </span><span class="pun">:</span> <span class="typ">String</span><span class="pun">},</span><span class="pln"><br>    content  </span><span class="pun">:</span> <span class="pun">{</span><span class="pln">type </span><span class="pun">:</span> <span class="typ">String</span><span class="pun">},</span><span class="pln"><br>    time     </span><span class="pun">:</span> <span class="pun">{</span><span class="pln">type </span><span class="pun">:</span> <span class="typ">Date</span><span class="pun">,</span> <span class="kwd">default</span><span class="pun">:</span> <span class="typ">Date</span><span class="pun">.</span><span class="pln">now</span><span class="pun">},</span><span class="pln"><br>    age      </span><span class="pun">:</span> <span class="pun">{</span><span class="pln">type </span><span class="pun">:</span> <span class="typ">Number</span><span class="pun">}</span><br><span class="pun">});</span></code></pre></p>
<p><pre class="prettyprint language-js"><code><span class="com">// 添加 mongoose 实例方法</span><span class="pln"><br>mongooseSchema</span><span class="pun">.</span><span class="pln">methods</span><span class="pun">.</span><span class="pln">findbyusername </span><span class="pun">=</span> <span class="kwd">function</span><span class="pun">(</span><span class="pln">username</span><span class="pun">,</span><span class="pln"> callback</span><span class="pun">)</span> <span class="pun">{</span><br>    <span class="kwd">return</span> <span class="kwd">this</span><span class="pun">.</span><span class="pln">model</span><span class="pun">(</span><span class="str">‘mongoose’</span><span class="pun">).</span><span class="pln">find</span><span class="pun">({</span><span class="pln">username</span><span class="pun">:</span><span class="pln"> username</span><span class="pun">},</span><span class="pln"> callback</span><span class="pun">);</span><br><span class="pun">}</span></code></pre></p>
<p><pre class="prettyprint language-js"><code><span class="com">// 添加 mongoose 静态方法，静态方法在Model层就能使用</span><span class="pln"><br>mongooseSchema</span><span class="pun">.</span><span class="pln">statics</span><span class="pun">.</span><span class="pln">findbytitle </span><span class="pun">=</span> <span class="kwd">function</span><span class="pun">(</span><span class="pln">title</span><span class="pun">,</span><span class="pln"> callback</span><span class="pun">)</span> <span class="pun">{</span><br>    <span class="kwd">return</span> <span class="kwd">this</span><span class="pun">.</span><span class="pln">model</span><span class="pun">(</span><span class="str">‘mongoose’</span><span class="pun">).</span><span class="pln">find</span><span class="pun">({</span><span class="pln">title</span><span class="pun">:</span><span class="pln"> title</span><span class="pun">},</span><span class="pln"> callback</span><span class="pun">);</span><br><span class="pun">}</span></code></pre></p>
<p><pre class="prettyprint language-js"><code><span class="com">// model</span><br><span class="kwd">var</span><span class="pln"> mongooseModel </span><span class="pun">=</span><span class="pln"> db</span><span class="pun">.</span><span class="pln">model</span><span class="pun">(</span><span class="str">‘mongoose’</span><span class="pun">,</span><span class="pln"> mongooseSchema</span><span class="pun">);</span></code></pre></p>
<p><pre class="prettyprint language-js"><code><span class="com">// 增加记录 基于 entity 操作</span><br><span class="kwd">var</span><span class="pln"> doc </span><span class="pun">=</span> <span class="pun">{</span><span class="pln">username </span><span class="pun">:</span> <span class="str">‘emtity_demo_username’</span><span class="pun">,</span><span class="pln"> title </span><span class="pun">:</span> <span class="str">‘emtity_demo_title’</span><span class="pun">,</span><span class="pln"> content </span><span class="pun">:</span> <span class="str">‘emtity_demo_content’</span><span class="pun">};</span><br><span class="kwd">var</span><span class="pln"> mongooseEntity </span><span class="pun">=</span> <span class="kwd">new</span><span class="pln"> mongooseModel</span><span class="pun">(</span><span class="pln">doc</span><span class="pun">);</span><span class="pln"><br>mongooseEntity</span><span class="pun">.</span><span class="pln">save</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">error</span><span class="pun">)</span> <span class="pun">{</span><br>    <span class="kwd">if</span><span class="pun">(</span><span class="pln">error</span><span class="pun">)</span> <span class="pun">{</span><span class="pln"><br>        console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">error</span><span class="pun">);</span><br>    <span class="pun">}</span> <span class="kwd">else</span> <span class="pun">{</span><span class="pln"><br>        console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">‘saved OK!’</span><span class="pun">);</span><br>    <span class="pun">}</span><br>    <span class="com">// 关闭数据库链接</span><span class="pln"><br>    db</span><span class="pun">.</span><span class="pln">close</span><span class="pun">();</span><br><span class="pun">});</span></code></pre></p>
<p><pre class="prettyprint language-js"><code><span class="com">// 增加记录 基于model操作</span><br><span class="kwd">var</span><span class="pln"> doc </span><span class="pun">=</span> <span class="pun">{</span><span class="pln">username </span><span class="pun">:</span> <span class="str">‘model_demo_username’</span><span class="pun">,</span><span class="pln"> title </span><span class="pun">:</span> <span class="str">‘model_demo_title’</span><span class="pun">,</span><span class="pln"> content </span><span class="pun">:</span> <span class="str">‘model_demo_content’</span><span class="pun">};</span><span class="pln"><br>mongooseModel</span><span class="pun">.</span><span class="pln">create</span><span class="pun">(</span><span class="pln">doc</span><span class="pun">,</span> <span class="kwd">function</span><span class="pun">(</span><span class="pln">error</span><span class="pun">){</span><br>    <span class="kwd">if</span><span class="pun">(</span><span class="pln">error</span><span class="pun">)</span> <span class="pun">{</span><span class="pln"><br>        console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">error</span><span class="pun">);</span><br>    <span class="pun">}</span> <span class="kwd">else</span> <span class="pun">{</span><span class="pln"><br>        console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">‘save ok’</span><span class="pun">);</span><br>    <span class="pun">}</span><br>    <span class="com">// 关闭数据库链接</span><span class="pln"><br>    db</span><span class="pun">.</span><span class="pln">close</span><span class="pun">();</span><br><span class="pun">});</span></code></pre></p>
<p><pre class="prettyprint language-js"><code><span class="com">// 修改记录</span><span class="pln"><br>mongooseModel</span><span class="pun">.</span><span class="pln">update</span><span class="pun">(</span><span class="pln">conditions</span><span class="pun">,</span><span class="pln"> update</span><span class="pun">,</span><span class="pln"> options</span><span class="pun">,</span><span class="pln"> callback</span><span class="pun">);</span><br><span class="kwd">var</span><span class="pln"> conditions </span><span class="pun">=</span> <span class="pun">{</span><span class="pln">username </span><span class="pun">:</span> <span class="str">‘model_demo_username’</span><span class="pun">};</span><br><span class="kwd">var</span><span class="pln"> update     </span><span class="pun">=</span> <span class="pun">{</span><span class="pln">$set </span><span class="pun">:</span> <span class="pun">{</span><span class="pln">age </span><span class="pun">:</span> <span class="lit">27</span><span class="pun">,</span><span class="pln"> title </span><span class="pun">:</span> <span class="str">‘model_demo_title_update’</span><span class="pun">}};</span><br><span class="kwd">var</span><span class="pln"> options    </span><span class="pun">=</span> <span class="pun">{</span><span class="pln">upsert </span><span class="pun">:</span> <span class="kwd">true</span><span class="pun">};</span><span class="pln"><br>mongooseModel</span><span class="pun">.</span><span class="pln">update</span><span class="pun">(</span><span class="pln">conditions</span><span class="pun">,</span><span class="pln"> update</span><span class="pun">,</span><span class="pln"> options</span><span class="pun">,</span> <span class="kwd">function</span><span class="pun">(</span><span class="pln">error</span><span class="pun">){</span><br>    <span class="kwd">if</span><span class="pun">(</span><span class="pln">error</span><span class="pun">)</span> <span class="pun">{</span><span class="pln"><br>        console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">error</span><span class="pun">);</span><br>    <span class="pun">}</span> <span class="kwd">else</span> <span class="pun">{</span><span class="pln"><br>        console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">‘update ok!’</span><span class="pun">);</span><br>    <span class="pun">}</span><br>    <span class="com">//关闭数据库链接</span><span class="pln"><br>    db</span><span class="pun">.</span><span class="pln">close</span><span class="pun">();</span><br><span class="pun">});</span></code></pre></p>
<p><pre class="prettyprint language-js"><code><span class="com">// 查询</span><br><span class="com">// 基于实例方法的查询</span><br><span class="kwd">var</span><span class="pln"> mongooseEntity </span><span class="pun">=</span> <span class="kwd">new</span><span class="pln"> mongooseModel</span><span class="pun">({});</span><span class="pln"><br>mongooseEntity</span><span class="pun">.</span><span class="pln">findbyusername</span><span class="pun">(</span><span class="str">‘model_demo_username’</span><span class="pun">,</span> <span class="kwd">function</span><span class="pun">(</span><span class="pln">error</span><span class="pun">,</span><span class="pln"> result</span><span class="pun">){</span><br>    <span class="kwd">if</span><span class="pun">(</span><span class="pln">error</span><span class="pun">)</span> <span class="pun">{</span><span class="pln"><br>        console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">error</span><span class="pun">);</span><br>    <span class="pun">}</span> <span class="kwd">else</span> <span class="pun">{</span><span class="pln"><br>        console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">result</span><span class="pun">);</span><br>    <span class="pun">}</span><br>    <span class="com">//关闭数据库链接</span><span class="pln"><br>    db</span><span class="pun">.</span><span class="pln">close</span><span class="pun">();</span><br><span class="pun">});</span></code></pre></p>
<p><pre class="prettyprint language-js"><code><span class="com">// 基于静态方法的查询</span><span class="pln"><br>mongooseModel</span><span class="pun">.</span><span class="pln">findbytitle</span><span class="pun">(</span><span class="str">‘emtity_demo_title’</span><span class="pun">,</span> <span class="kwd">function</span><span class="pun">(</span><span class="pln">error</span><span class="pun">,</span><span class="pln"> result</span><span class="pun">){</span><br>    <span class="kwd">if</span><span class="pun">(</span><span class="pln">error</span><span class="pun">)</span> <span class="pun">{</span><span class="pln"><br>        console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">error</span><span class="pun">);</span><br>    <span class="pun">}</span> <span class="kwd">else</span> <span class="pun">{</span><span class="pln"><br>        console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">result</span><span class="pun">);</span><br>    <span class="pun">}</span><br>    <span class="com">//关闭数据库链接</span><span class="pln"><br>    db</span><span class="pun">.</span><span class="pln">close</span><span class="pun">();</span><br><span class="pun">});</span></code></pre></p>
<p><pre class="prettyprint language-js"><code><span class="com">// mongoose find</span><br><span class="kwd">var</span><span class="pln"> criteria </span><span class="pun">=</span> <span class="pun">{</span><span class="pln">title </span><span class="pun">:</span> <span class="str">‘emtity_demo_title’</span><span class="pun">};</span> <span class="com">// 查询条件</span><br><span class="kwd">var</span><span class="pln"> fields   </span><span class="pun">=</span> <span class="pun">{</span><span class="pln">title </span><span class="pun">:</span> <span class="lit">1</span><span class="pun">,</span><span class="pln"> content </span><span class="pun">:</span> <span class="lit">1</span><span class="pun">,</span><span class="pln"> time </span><span class="pun">:</span> <span class="lit">1</span><span class="pun">};</span> <span class="com">// 待返回的字段</span><br><span class="kwd">var</span><span class="pln"> options  </span><span class="pun">=</span> <span class="pun">{};</span><span class="pln"><br>mongooseModel</span><span class="pun">.</span><span class="pln">find</span><span class="pun">(</span><span class="pln">criteria</span><span class="pun">,</span><span class="pln"> fields</span><span class="pun">,</span><span class="pln"> options</span><span class="pun">,</span> <span class="kwd">function</span><span class="pun">(</span><span class="pln">error</span><span class="pun">,</span><span class="pln"> result</span><span class="pun">){</span><br>    <span class="kwd">if</span><span class="pun">(</span><span class="pln">error</span><span class="pun">)</span> <span class="pun">{</span><span class="pln"><br>        console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">error</span><span class="pun">);</span><br>    <span class="pun">}</span> <span class="kwd">else</span> <span class="pun">{</span><span class="pln"><br>        console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">result</span><span class="pun">);</span><br>    <span class="pun">}</span><br>    <span class="com">//关闭数据库链接</span><span class="pln"><br>    db</span><span class="pun">.</span><span class="pln">close</span><span class="pun">();</span><br><span class="pun">});</span></code></pre></p>
<p><pre class="prettyprint language-js"><code><span class="com">// 删除记录</span><br><span class="kwd">var</span><span class="pln"> conditions </span><span class="pun">=</span> <span class="pun">{</span><span class="pln">username</span><span class="pun">:</span> <span class="str">‘emtity_demo_username’</span><span class="pun">};</span><span class="pln"><br>mongooseModel</span><span class="pun">.</span><span class="pln">remove</span><span class="pun">(</span><span class="pln">conditions</span><span class="pun">,</span> <span class="kwd">function</span><span class="pun">(</span><span class="pln">error</span><span class="pun">){</span><br>    <span class="kwd">if</span><span class="pun">(</span><span class="pln">error</span><span class="pun">)</span> <span class="pun">{</span><span class="pln"><br>        console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">error</span><span class="pun">);</span><br>    <span class="pun">}</span> <span class="kwd">else</span> <span class="pun">{</span><span class="pln"><br>        console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">‘delete ok!’</span><span class="pun">);</span><br>    <span class="pun">}</span></code></pre></p>
<pre><code>&lt;span class=&quot;com&quot;&gt;//关闭数据库链接&lt;/span&gt;&lt;span class=&quot;pln&quot;&gt;
db&lt;/span&gt;&lt;span class=&quot;pun&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;pln&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;pun&quot;&gt;();&lt;/span&gt;
</code></pre><p><span class="pun">});</span><br>学习参考文档<br><a href="http://ourjs.com/detail/53ad24edb984bb4659000013" target="_blank" rel="external">http://ourjs.com/detail/53ad24edb984bb4659000013</a></p>

					</div>


					<div class="content-tag">

<a class="tag-link" href="/tags/mongoose/">mongoose</a>, <a class="tag-link" href="/tags/nodejs/">nodejs</a>, <a class="tag-link" href="/tags/note/">note</a>, <a class="tag-link" href="/tags/笔记/">笔记</a>

					</div>



				</article>
			</div>

		</div>

		<div class="panel-post-nav">
			<div class="box-post-nav">


					<a href="/2016/04/07/Express-学习笔记/" title="">&larr; Prev</a>



					<a href="/2016/04/07/Nodejs--学习笔记/" title="Nodejs--学习笔记">Next &rarr;</a>


			</div>
		</div>
		<div class="content-comments">
		
  <section id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="2016/04/07/Mongoose--学习笔记/index.html" data-title="Mongoose--学习笔记" data-url="/2016/04/07/Mongoose--学习笔记/"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:'pengweb'};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
    <!-- 多说公共JS代码 end -->
  </section>
  
		</div>
		

	</div>

	<div class="layout-footer" style="clear: both">
		<div class="panel-footer">
			<div class="box-footer">
				<footer class="footer">
					<p class="cr">&copy; 2016 <a href="https://github.com/pengweb"  target="_blank" target="_blank">Pengzhang</a> 
					<span class="theme">Powered: <a href="https://github.com/pengweb/pengweb.github.io" target="_blank">pengweb.net</a>, 京ICP备: <a href="" target="_blank">15017479</a></span>
					</p>

					
				</footer>
			</div>
		</div>
	</div>




</body>
</html>
