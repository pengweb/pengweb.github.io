<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>

	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<title> MongoDB--学习笔记 | 张鹏的全栈之路 </title>
	<meta property="og:title" content=" MongoDB--学习笔记 | 张鹏的全栈之路 " />
	<meta name="twitter:title" content=" MongoDB--学习笔记 | 张鹏的全栈之路 ">

	<meta property="og:type" content="article">
	<meta name="twitter:card" content="summary">

	<meta name="description" content=" MongoDB--学习笔记 | 张鹏的全栈之路 ">
	<meta property="og:description" content=" MongoDB--学习笔记 | 张鹏的全栈之路 " />
	<meta name="twitter:description" content=" MongoDB--学习笔记 | 张鹏的全栈之路 " />

	<link rel="icon" type="image/x-icon" href="/asset/img/favicon.png">

	<link rel="image_src" href="/asset/img/logo.png" >
	<meta property="og:image" content="/asset/img/logo.png" />

	<link href="http://yoursite.com/atom.xml" title="张鹏的全栈之路" type="application/atom+xml" rel="alternative">

	<link rel="canonical" href="/2016/04/07/MongoDB--学习笔记/index.html">

	<link rel="stylesheet" href="/asset/css/style.css">

</head>

<body>

	<div class="layout-header">
		<header class="header">
			<div class="layout-logo">
				<div class="panel-logo">

					<div class="box-logo box-log-md">
						<a href="/" title="张鹏的全栈之路"><img src="/asset/img/logo.png" class="img-logo"></a>
					</div>
					<div class="box-main-title">
						<h5 style="text-align: center">
							<span>Love life,love ourselves！--Pengzhang</span>
						</h5>
					</div>
					<div class="box-sub-title">

					</div>
				</div>
			</div>
			<div class="layout-menu">
				<div class="box-logo box-log-xs">
					<a href="/" title="张鹏的全栈之路"><img src="/asset/img/logo.png" class="img-logo"></a>
				</div>
				<div class="box-menu-list">
					<nav class="page-nav">
						<ul class="menu-list">

							<li class="box-menu-item"><a href="/"><span class="menu-item">HOME</span></a></li>

							<li class="box-menu-item"><a href="/tags/js"><span class="menu-item">Javascript</span></a></li>

							<li class="box-menu-item"><a href="/tags/nodejs"><span class="menu-item">Node.js</span></a></li>

							<li class="box-menu-item"><a href="/tags/html"><span class="menu-item">Html</span></a></li>

							<li class="box-menu-item"><a href="/tags/css"><span class="menu-item">Css</span></a></li>

							<li class="box-menu-item"><a href="/tags/note"><span class="menu-item">Note</span></a></li>

							<li class="box-menu-item"><a href="/tags/others"><span class="menu-item">Others</span></a></li>

							<li class="box-menu-item"><a href="/archives"><span class="menu-item">Sitemap</span></a></li>

						</ul>
					</nav>

				</div>
			</div>
		</header>
	</div>

	<div class="layout-content">


		<div class="row panel-content panel-post-item">
			<div class="box-post-item">
				<article class="post-item" itemscope itemtype="http://schema.org/Article">




					<p class="content-meta">
						<span class="meta-date" itemprop="datePublished" content="2016-04-07">2016-04-07</span>


					</p>


					<h2 class="box-content-title">
						<a href="/2016/04/07/MongoDB--学习笔记/"  itemprop="url"><span class="content-title" itemprop="name">MongoDB--学习笔记</span></a>
					</h2>

					<div class="content post-item-content" itemprop="articleBody">

<p>一、创建数据目录<br><figure class="highlight js"><figcaption><span>c:\data\bd\```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">二、命令行下运行 MongoDB 服务器</span><br><span class="line"><span class="string">``</span><span class="string">`js mongod.exe --dbpath c:\data\db //有的时候可以去掉.exe</span></span><br></pre></td></tr></table></figure></p>
<p>三、将MongoDB服务器作为Windows服务运行<br><figure class="highlight js"><figcaption><span>mongod.exe</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--bind_ip yourIPadress</span><br><span class="line">--port yourPortNumber</span><br><span class="line">--logpath <span class="string">"C:\data\mongodb.log"</span></span><br><span class="line">--logappend --dbpath <span class="string">"C:\data\db"</span></span><br><span class="line">--serviceName <span class="string">"YourServiceName"</span></span><br><span class="line">--serviceDisplayName <span class="string">"YourServiceName"</span></span><br><span class="line">--install</span><br></pre></td></tr></table></figure></p>
<figure class="highlight js"><figcaption><span>mongod.exe --logpath "C:\data\mongodb.log" --logappend --dbpath "C:\data\db" --serviceName "zhp" --serviceDisplayName "zhpdisplay" --install```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">--bind_ip 绑定服务IP，若绑定<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>，则只能本机访问，不指定默认本地所有IP</span><br><span class="line">--logpath 定MongoDB日志文件，注意是指定文件不是目录</span><br><span class="line">--logappend 使用追加的方式写日志</span><br><span class="line">--dbpath 指定数据库路径</span><br><span class="line">--port 指定服务端口号，默认端口<span class="number">27017</span></span><br><span class="line">--serviceName 指定服务名称</span><br><span class="line">--serviceDisplayNam 指定服务名称，有多个mongodb服务时执行。</span><br><span class="line">--install 指定作为一个Windows服务安装。</span><br><span class="line"></span><br><span class="line">MongoDB后台管理 Shell</span><br><span class="line">如果你需要进入MongoDB后台管理，你需要先打开mongodb装目录的下的bin目录，然后执行mongo.exe文件，MongoDB Shell是MongoDB自带的交互式Javascript shell,用来对MongoDB进行操作和管理的交互式环境。</span><br><span class="line">当你进入mongoDB后台后，它默认会链接到 test 文档（数据库）：</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt; mongo</span><br><span class="line">MongoDB shell version: 3.0.6</span><br><span class="line">connecting to: test</span><br><span class="line">……</span></span><br></pre></td></tr></table></figure>
<p>db 命令用于查看当前操作的文档（数据库）：<br><figure class="highlight js"><figcaption><span>> db</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">test</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></p>
<p>插入一些简单的记录并查找它：</p>
<blockquote>
<p>db.pengweb.insert({x:10})<br>WriteResult({ “nInserted” : 1 })<br>db.pengweb.find()<br>{ “_id” : ObjectId(“5604ff74a274a611b0c990aa”), “x” : 10 }</p>
<p>第一个命令将数字 10 插入到 pengweb 集合的 x 字段中。</p>
</blockquote>
<p>MongoDB 概念解析<br>不管我们学习什么数据库都应该学习其中的基础概念，在mongodb中基本的概念是文档、集合、数据库，下面我们挨个介绍。<br>下表将帮助您更容易理解Mongo中的一些概念：</p>
<p>&nbsp;</p>
<p><table class="reference"></table></p>
<p><tbody></tbody></p>
<p><tr></tr></p>
<p><th>SQL术语/概念</th></p>
<p><th>MongoDB术语/概念</th></p>
<p><th>解释/说明</th><br></p>
<p><tr></tr></p>
<p><td>database</td></p>
<p><td>database</td></p>
<p><td>数据库</td><br></p>
<p><tr></tr></p>
<p><td>table</td></p>
<p><td>collection</td></p>
<p><td>数据库表/集合</td><br></p>
<p><tr></tr></p>
<p><td>row</td></p>
<p><td>document</td></p>
<p><td>数据记录行/文档</td><br></p>
<p><tr></tr></p>
<p><td>column</td></p>
<p><td>field</td></p>
<p><td>数据字段/域</td><br></p>
<p><tr></tr></p>
<p><td>index</td></p>
<p><td>index</td></p>
<p><td>索引</td><br></p>
<p><tr></tr></p>
<p><td>table joins</td></p>
<p><td></td></p>
<p><td>表连接,MongoDB不支持</td><br></p>
<p><tr></tr></p>
<p><td>primary key</td></p>
<p><td>primary key</td></p>
<p><td>主键,MongoDB自动将_id字段设置为主键</td><br><br><br><br>通过下图实例，我们也可以更直观的的了解Mongo中的一些概念：</p>
<p><img src="http://www.runoob.com/wp-content/uploads/2013/10/Figure-1-Mapping-Table-to-Collection-1.png" alt=""></p>
<p>数据库<br>一个mongodb中可以建立多个数据库。<br>MongoDB的默认数据库为”db”，该数据库存储在data目录中。<br>MongoDB的单个实例可以容纳多个独立的数据库，每一个都有自己的集合和权限，不同的数据库也放置在不同的文件中。<br>“show dbs” 命令可以显示所有数据的列表。<br><figure class="highlight js"><figcaption><span>$ ./mongo</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MongoDB shell version: <span class="number">3.0</span><span class="number">.6</span></span><br><span class="line">connecting to: test</span><br><span class="line">&gt; show dbs</span><br><span class="line">local <span class="number">0.078</span>GB</span><br><span class="line">test <span class="number">0.078</span>GB</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></p>
<p>执行 “db” 命令可以显示当前数据库对象或集合。<br><figure class="highlight js"><figcaption><span>$ ./mongo</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MongoDB shell version: <span class="number">3.0</span><span class="number">.6</span></span><br><span class="line">connecting to: test</span><br><span class="line">&gt; db</span><br><span class="line">test</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></p>
<p>运行”use”命令，可以连接到一个指定的数据库。<br><figure class="highlight js"><figcaption><span>> use local</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">switched to db local</span><br><span class="line">&gt; db</span><br><span class="line">local</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></p>
<p>数据库也通过名字来标识。数据库名可以是满足以下条件的任意UTF-8字符串。<br>不能是空字符串（””)。<br>不得含有’ ‘（空格)、.、$、/、\和\0 (空宇符)。<br>应全部小写。<br>最多64字节。</p>
<p>文档<br>文档是mongodb中的最核心的概念，是其核心单元，我们可以将文档类比成关系型数据库中的每一行数据。<br>多个键及其关联的值有序的放置在一起就是文档。MongoDB使用了BSON这种结构来存储数据和网络数据交换。<br>BSON数据可以理解为在JSON的基础上添加了一些json中没有的数据类型。<br>如果我们会JSON，那么BSON我们就已经掌握了一半了，至于新添加的数据类型后面我会介绍。<br>文档例子如下：<br>{ site : “runoob.com” }<br>通常，”object（对象）” 术语是指一个文档。<br>文档类似于一个RDBMS的记录</p>
<p>集合<br>集合就是一组文档的组合。如果将文档类比成数据库中的行，那么集合就可以类比成数据库的表。<br>在mongodb中的集合是无模式的，也就是说集合中存储的文档的结构可以是不同的，比如下面的两个文档可以同时存入到一个集合中：<br><figure class="highlight js"><figcaption><span>&#123;"name":"mengxiangyue"&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"Name"</span>:<span class="string">"mengxiangyue"</span>,<span class="string">"sex"</span>:<span class="string">"nan"</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>当第一个文档插入时，集合就会被创建。<br>合法的集合名<br>集合名不能是空字符串””。<br>集合名不能含有\0字符（空字符)，这个字符表示集合名的结尾。<br>集合名不能以”system.”开头，这是为系统集合保留的前缀。<br>用户创建的集合名字不能含有保留字符。有些驱动程序的确支持在集合名里面包含，这是因为某些系统生成的集合中包含该字符。除非你要访问这种系统创建的集合，否则千万不要在名字里出现$。<br>如下实例：<br><figure class="highlight js"><figcaption><span>db.col.findOne()</span><a href="//col是集合名">findOne是方法```</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">capped collections</span><br><span class="line">Capped collections 就是固定大小的collection。</span><br><span class="line">它有很高的性能以及队列过期的特性(过期按照插入的顺序). 有点和 <span class="string">"RRD"</span> 概念类似。</span><br><span class="line">Capped collections是高性能自动的维护对象的插入顺序。它非常适合类似记录日志的功能 和标准的collection不同，你必须要显式的创建一个capped collection， 指定一个collection的大小，单位是字节。collection的数据存储空间值提前分配的。</span><br><span class="line">要注意的是指定的存储大小包含了数据库的头信息。</span><br><span class="line">db.createCollection(<span class="string">"mycoll"</span>, &#123;capped:<span class="literal">true</span>, size:<span class="number">100000</span>&#125;)</span><br><span class="line">在capped collection中，你能添加新的对象。</span><br><span class="line">能进行更新，然而，对象不会增加存储空间。如果增加，更新就会失败 。</span><br><span class="line">数据库不允许进行删除。使用drop()方法删除collection所有的行。</span><br><span class="line">注意: 删除之后，你必须显式的重新创建这个collection。</span><br><span class="line">在<span class="number">32</span>bit机器中，capped collection最大存储为<span class="number">1e9</span>( <span class="number">1</span>X109)个字节。</span><br><span class="line">元数据</span><br><span class="line">数据库的信息是存储在集合中。它们使用了系统的命名空间：</span><br><span class="line">dbname.system.*</span><br><span class="line">在MongoDB数据库中名字空间 .system.* 是包含多种系统信息的特殊集合(Collection)，如下:</span><br><span class="line">集合命名空间 描述</span><br><span class="line">dbname.system.namespaces 列出所有名字空间。</span><br><span class="line">dbname.system.indexes 列出所有索引。</span><br><span class="line">dbname.system.profile 包含数据库概要(profile)信息。</span><br><span class="line">dbname.system.users 列出所有可访问数据库的用户。</span><br><span class="line">dbname.local.sources 包含复制对端（slave）的服务器信息和状态。</span><br><span class="line">对于修改系统集合中的对象有如下限制。</span><br><span class="line">在&#123;&#123;system.indexes&#125;&#125;插入数据，可以创建索引。但除此之外该表信息是不可变的(特殊的drop index命令将自动更新相关信息)。</span><br><span class="line">&#123;&#123;system.users&#125;&#125;是可修改的。 &#123;&#123;system.profile&#125;&#125;是可删除的。</span><br><span class="line"></span><br><span class="line">MongoDB - 连接</span><br><span class="line">通过shell连接MongoDB服务</span><br><span class="line">你可以通过执行以下命令来连接MongoDB的服务。</span><br><span class="line">注意：localhost为主机名，这个选项是必须的：</span><br><span class="line">mongodb:<span class="comment">//localhost</span></span><br><span class="line">当你执行以上命令时</span><br><span class="line"></span><br><span class="line">MongoDB连接命令格式</span><br><span class="line">使用用户名和密码连接到MongoDB服务器，你必须使用 <span class="string">'username:password@hostname/dbname'</span> 格式，<span class="string">'username'</span>为用户名，<span class="string">'password'</span> 为密码。</span><br><span class="line">使用用户名和密码连接登陆到默认数据库：</span><br><span class="line"><span class="string">``</span><span class="string">`js $ ./mongo</span><br><span class="line">MongoDB shell version: 3.0.6</span><br><span class="line">connecting to: test</span><br><span class="line">mongodb://admin:123456@localhost/</span></span><br></pre></td></tr></table></figure></p>
<p>以上命令中，用户 admin 使用密码 123456 连接到本地的 MongoDB 服务上。输出结果如下所示：&lt;、p&gt;<br><figure class="highlight js"><figcaption><span>> mongodb://admin:123456@localhost/</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>更多连接实例<br>连接本地数据库服务器，端口是默认的。<br><figure class="highlight js"><figcaption><span>mongodb://localhost```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">使用用户名fred，密码foobar登录localhost的admin数据库。</span><br><span class="line"><span class="string">``</span><span class="string">`js mongodb://fred:foobar@localhost</span></span><br></pre></td></tr></table></figure></p>
<p>使用用户名fred，密码foobar登录localhost的baz数据库。<br><figure class="highlight js"><figcaption><span>mongodb://fred:foobar@localhost/baz```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">连接 replica pair, 服务器<span class="number">1</span>为example1.com服务器<span class="number">2</span>为example2。</span><br><span class="line"><span class="string">``</span><span class="string">`js mongodb://example1.com:27017,example2.com:27017</span></span><br></pre></td></tr></table></figure></p>
<p>连接 replica set 三台服务器 (端口 27017, 27018, 和27019):<br><figure class="highlight js"><figcaption><span>mongodb://localhost,localhost:27018,localhost:27019```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">连接 replica set 三台服务器, 写入操作应用在主服务器 并且分布查询到从服务器。</span><br><span class="line"><span class="string">``</span><span class="string">`js mongodb://host1,host2,host3/?slaveOk=true</span></span><br></pre></td></tr></table></figure></p>
<p>直接连接第一个服务器，无论是replica set一部分或者主服务器或者从服务器。<br><figure class="highlight js"><figcaption><span>mongodb://host1,host2,host3/?connect=direct;slaveOk=true```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">当你的连接服务器有优先级，还需要列出所有服务器，你可以使用上述连接方式。</span><br><span class="line">安全模式连接到localhost:</span><br><span class="line"><span class="string">``</span><span class="string">`js mongodb://localhost/?safe=true</span></span><br></pre></td></tr></table></figure></p>
<p>以安全模式连接到replica set，并且等待至少两个复制服务器成功写入，超时时间设置为2秒。<br><figure class="highlight js"><figcaption><span>mongodb://host1,host2,host3/?safe=true;w=2;wtimeoutMS=2000```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">参数说明：请查看api</span><br><span class="line"></span><br><span class="line">MongoDB 创建数据库</span><br><span class="line">语法</span><br><span class="line">MongoDB 创建数据库的语法格式如下：</span><br><span class="line"><span class="string">``</span><span class="string">`js use DATABASE_NAME</span></span><br></pre></td></tr></table></figure></p>
<p>如果数据库不存在，则创建数据库，否则切换到指定数据库。</p>
<p>我们刚创建的数据库 runoob 并不在数据库的列表中， 要显示它，我们需要向 runoob 数据库插入一些数据。<br><figure class="highlight js"><figcaption><span>> db.runoob.insert(&#123;"name":"菜鸟教程"&#125;)</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">WriteResult(&#123; <span class="string">"nInserted"</span> : <span class="number">1</span> &#125;)</span><br><span class="line">&gt; show dbs</span><br><span class="line">local <span class="number">0.078</span>GB</span><br><span class="line">runoob <span class="number">0.078</span>GB</span><br><span class="line">test <span class="number">0.078</span>GB</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></p>
<p>MongoDB 中默认的数据库为 test，如果你没有创建新的数据库，集合将存放在 test 数据库中。</p>
<p>MongoDB 删除数据库<br>语法<br>MongoDB 删除数据库的语法格式如下：<br>db.dropDatabase()<br>删除当前数据库，默认为 test，你可以使用 db 命令查看当前数据库名。</p>
<p>执行删除命令：<br><figure class="highlight js"><figcaption><span>> db.dropDatabase()</span><a href="//切换到要删除的目录下，执行这个语句，就会删除了">link</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="string">"dropped"</span> : <span class="string">"runoob"</span>, <span class="string">"ok"</span> : <span class="number">1</span> &#125;</span><br></pre></td></tr></table></figure></p>
<p>MongoDB 插入文档<br>本章节中我们将向大家介绍如何将数据插入到MongoDB的集合中。<br>文档的数据结构和JSON基本一样。<br>所有存储在集合中的数据都是BSON格式。<br>BSON是一种类json的一种二进制形式的存储格式,简称Binary JSON。<br>插入文档<br>MongoDB 使用 insert() 或 save() 方法向集合中插入文档，语法如下：<br><figure class="highlight js"><figcaption><span>db.COLLECTION_NAME.insert(document)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">实例</span><br><span class="line">以下文档可以存储在 MongoDB 的 runoob 数据库 的 col集合中：</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt;db.col.insert(&#123;title: 'MongoDB 教程',</span><br><span class="line">description: 'MongoDB 是一个 Nosql 数据库',</span><br><span class="line">by: '菜鸟教程',</span><br><span class="line">url: 'http://www.runoob.com',</span><br><span class="line">tags: ['mongodb', 'database', 'NoSQL'],</span><br><span class="line">likes: 100</span><br><span class="line">&#125;)</span></span><br></pre></td></tr></table></figure></p>
<p>以上实例中 col 是我们的集合名，前一章节我们已经创建过了，如果该集合不在该数据库中， MongoDB 会自动创建该集合比插入文档。<br>查看已插入文档：<br><figure class="highlight js"><figcaption><span>> db.col.find()</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"56064886ade2f21f36b03134"</span>), <span class="string">"title"</span> : <span class="string">"MongoDB 教程"</span>, <span class="string">"description"</span> : <span class="string">"MongoDB 是一个 Nosql 数据库"</span>, <span class="string">"by"</span> : <span class="string">"菜鸟教程"</span>, <span class="string">"url"</span> : <span class="string">"http://www.runoob.com"</span>, <span class="string">"tags"</span> : [ <span class="string">"mongodb"</span>, <span class="string">"database"</span>, <span class="string">"NoSQL"</span> ], <span class="string">"likes"</span> : <span class="number">100</span> &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></p>
<p>我们也可以将数据定义为一个变量，如下所示：<br><figure class="highlight js"><figcaption><span>> document=(&#123;title: 'MongoDB 教程',</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">description: <span class="string">'MongoDB 是一个 Nosql 数据库'</span>,</span><br><span class="line">by: <span class="string">'菜鸟教程'</span>,</span><br><span class="line">url: <span class="string">'http://www.runoob.com'</span>,</span><br><span class="line">tags: [<span class="string">'mongodb'</span>, <span class="string">'database'</span>, <span class="string">'NoSQL'</span>],</span><br><span class="line">likes: <span class="number">100</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>执行后显示结果如下：<br><figure class="highlight js"><figcaption><span>&#123;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"title"</span> : <span class="string">"MongoDB 教程"</span>,</span><br><span class="line"><span class="string">"description"</span> : <span class="string">"MongoDB 是一个 Nosql 数据库"</span>,</span><br><span class="line"><span class="string">"by"</span> : <span class="string">"菜鸟教程"</span>,</span><br><span class="line"><span class="string">"url"</span> : <span class="string">"http://www.runoob.com"</span>,</span><br><span class="line"><span class="string">"tags"</span> : [</span><br><span class="line"><span class="string">"mongodb"</span>,</span><br><span class="line"><span class="string">"database"</span>,</span><br><span class="line"><span class="string">"NoSQL"</span></span><br><span class="line">],</span><br><span class="line"><span class="string">"likes"</span> : <span class="number">100</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>执行插入操作：<br><figure class="highlight js"><figcaption><span>> db.col.insert(document)</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">WriteResult(&#123; <span class="string">"nInserted"</span> : <span class="number">1</span> &#125;)</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></p>
<p>MongoDB 更新文档<br>MongoDB 使用 update() 和 save() 方法来更新集合中的文档。接下来让我们详细来看下两个函数的应用及其区别。<br>update() 方法<br>update() 方法用于更新已存在的文档。语法格式如下：<br><figure class="highlight js"><figcaption><span>db.collection.update(</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">,</span><br><span class="line">,</span><br><span class="line">&#123;</span><br><span class="line">upsert: ,</span><br><span class="line">multi: ,</span><br><span class="line">writeConcern:</span><br><span class="line">&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>参数说明：<br>query : update的查询条件，类似sql update查询内where后面的。<br>update : update的对象和一些更新的操作符（如$,$inc…）等，也可以理解为sql update查询内set后面的<br>upsert : 可选，这个参数的意思是，如果不存在update的记录，是否插入objNew,true为插入，默认是false，不插入。<br>multi : 可选，mongodb 默认是false,只更新找到的第一条记录，如果这个参数为true,就把按条件查出来多条记录全部更新。<br>writeConcern :可选，抛出异常的级别。<br><figure class="highlight js"><figcaption><span>>db.col.insert(&#123;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">title: <span class="string">'MongoDB 教程'</span>,</span><br><span class="line">description: <span class="string">'MongoDB 是一个 Nosql 数据库'</span>,</span><br><span class="line">by: <span class="string">'菜鸟教程'</span>,</span><br><span class="line">url: <span class="string">'http://www.runoob.com'</span>,</span><br><span class="line">tags: [<span class="string">'mongodb'</span>, <span class="string">'database'</span>, <span class="string">'NoSQL'</span>],</span><br></pre></td></tr></table></figure></p>
<p>likes: 100<br>})<br>接着我们通过 update() 方法来更新标题(title):<br><figure class="highlight"><figcaption><span>>db.col.update(&#123;'title':'MongoDB 教程'&#125;,&#123;$set:&#123;'title':'MongoDB'&#125;&#125;)</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">WriteResult(&#123; "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 &#125;) # 输出信息</span><br><span class="line">&gt; db.col.find().pretty()</span><br><span class="line">&#123;</span><br><span class="line">"_id" : ObjectId("56064f89ade2f21f36b03136"),</span><br><span class="line">"title" : "MongoDB",</span><br><span class="line">"description" : "MongoDB 是一个 Nosql 数据库",</span><br><span class="line">"by" : "菜鸟教程",</span><br><span class="line">"url" : "http://www.runoob.com",</span><br><span class="line">"tags" : [</span><br><span class="line">"mongodb",</span><br><span class="line">"database",</span><br><span class="line">"NoSQL"</span><br><span class="line">],</span><br><span class="line">"likes" : 100</span><br><span class="line">&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></p>
<p>save() 方法<br>save() 方法通过传入的文档来替换已有文档。语法格式如下：<br>db.collection.save(<br>,<br>{<br>writeConcern:<br>}<br>)<br>参数说明：<br>document : 文档数据。<br>writeConcern :可选，抛出异常的级别。<br>实例<br>以下实例中我们替换了 _id 为 56064f89ade2f21f36b03136 的文档数据：<br><figure class="highlight js"><figcaption><span>>db.col.save(&#123;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"_id"</span> : ObjectId(<span class="string">"56064f89ade2f21f36b03136"</span>),</span><br><span class="line"><span class="string">"title"</span> : <span class="string">"MongoDB"</span>,</span><br><span class="line"><span class="string">"description"</span> : <span class="string">"MongoDB 是一个 Nosql 数据库"</span>,</span><br><span class="line"><span class="string">"by"</span> : <span class="string">"Runoob"</span>,</span><br><span class="line"><span class="string">"url"</span> : <span class="string">"http://www.runoob.com"</span>,</span><br><span class="line"><span class="string">"tags"</span> : [</span><br><span class="line"><span class="string">"mongodb"</span>,</span><br><span class="line"><span class="string">"NoSQL"</span></span><br><span class="line">],</span><br><span class="line"><span class="string">"likes"</span> : <span class="number">110</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>替换成功后，我们可以通过 find() 命令来查看替换后的数据<br><figure class="highlight js"><figcaption><span>>db.col.find().pretty()</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">"_id"</span> : ObjectId(<span class="string">"56064f89ade2f21f36b03136"</span>),</span><br><span class="line"><span class="string">"title"</span> : <span class="string">"MongoDB"</span>,</span><br><span class="line"><span class="string">"description"</span> : <span class="string">"MongoDB 是一个 Nosql 数据库"</span>,</span><br><span class="line"><span class="string">"by"</span> : <span class="string">"Runoob"</span>,</span><br><span class="line"><span class="string">"url"</span> : <span class="string">"http://www.runoob.com"</span>,</span><br><span class="line"><span class="string">"tags"</span> : [</span><br><span class="line"><span class="string">"mongodb"</span>,</span><br><span class="line"><span class="string">"NoSQL"</span></span><br><span class="line">],</span><br><span class="line"><span class="string">"likes"</span> : <span class="number">110</span></span><br><span class="line">&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></p>
<p>更多实例<br>只更新第一条记录：<br><figure class="highlight js"><figcaption><span>db.col.update( &#123; "count" : &#123; $gt : 1 &#125; &#125; , &#123; $set : &#123; "test2" : "OK"&#125; &#125; );```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">全部更新：</span><br><span class="line"><span class="string">``</span><span class="string">`js db.col.update( &#123; "count" : &#123; $gt : 3 &#125; &#125; , &#123; $set : &#123; "test2" : "OK"&#125; &#125;,false,true );</span></span><br></pre></td></tr></table></figure></p>
<p>只添加第一条：<br><figure class="highlight js"><figcaption><span>db.col.update( &#123; "count" : &#123; $gt : 4 &#125; &#125; , &#123; $set : &#123; "test5" : "OK"&#125; &#125;,true,false );```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">全部添加加进去:</span><br><span class="line"><span class="string">``</span><span class="string">`js db.col.update( &#123; "count" : &#123; $gt : 5 &#125; &#125; , &#123; $set : &#123; "test5" : "OK"&#125; &#125;,true,true );</span></span><br></pre></td></tr></table></figure></p>
<p>全部更新：<br><figure class="highlight js"><figcaption><span>db.col.update( &#123; "count" : &#123; $gt : 15 &#125; &#125; , &#123; $inc : &#123; "count" : 1&#125; &#125;,false,true );```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">只更新第一条记录：</span><br><span class="line"><span class="string">``</span><span class="string">`js db.col.update( &#123; "count" : &#123; $gt : 10 &#125; &#125; , &#123; $inc : &#123; "count" : 1&#125; &#125;,false,false );</span></span><br></pre></td></tr></table></figure></p>
<p>MongoDB 删除文档<br>在前面的几个章节中我们已经学习了MongoDB中如何为集合添加数据和更新数据。在本章节中我们将继续学习MongoDB集合的删除。<br>MongoDB remove()函数是用来移除集合中的数据。<br>MongoDB数据更新可以使用update()函数。在执行remove()函数前先执行find()命令来判断执行的条件是否正确，这是一个比较好的习惯。<br>语法<br>remove() 方法的基本语法格式如下所示：<br><figure class="highlight js"><figcaption><span>db.collection.remove(</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">,</span><br><span class="line"></span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>如果你的 MongoDB 是 2.6 版本以后的，语法格式如下：<br><figure class="highlight js"><figcaption><span>db.collection.remove(</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">,</span><br><span class="line">&#123;</span><br><span class="line">justOne: ,</span><br><span class="line">writeConcern:</span><br><span class="line">&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>参数说明：<br>query :（可选）删除的文档的条件。<br>justOne : （可选）如果设为 true 或 1，则只删除一个文档。<br>writeConcern :（可选）抛出异常的级别。</p>
<p>实例<br>以下文档我们执行两次插入操作：<br><figure class="highlight js"><figcaption><span>>db.col.insert(&#123;title: 'MongoDB 教程',</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">description: <span class="string">'MongoDB 是一个 Nosql 数据库'</span>,</span><br><span class="line">by: <span class="string">'菜鸟教程'</span>,</span><br><span class="line">url: <span class="string">'http://www.runoob.com'</span>,</span><br><span class="line">tags: [<span class="string">'mongodb'</span>, <span class="string">'database'</span>, <span class="string">'NoSQL'</span>],</span><br><span class="line">likes: <span class="number">100</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>使用 find() 函数查询数据：<br><figure class="highlight"><figcaption><span>> db.col.find()</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123; "_id" : ObjectId("56066169ade2f21f36b03137"), "title" : "MongoDB 教程", "description" : "MongoDB 是一个 Nosql 数据库", "by" : "菜鸟教程", "url" : "http://www.runoob.com", "tags" : [ "mongodb", "database", "NoSQL" ], "likes" : 100 &#125;</span><br><span class="line">&#123; "_id" : ObjectId("5606616dade2f21f36b03138"), "title" : "MongoDB 教程", "description" : "MongoDB 是一个 Nosql 数据库", "by" : "菜鸟教程", "url" : "http://www.runoob.com", "tags" : [ "mongodb", "database", "NoSQL" ], "likes" : 100 &#125;</span><br><span class="line">接下来我们移除 title 为 'MongoDB 教程' 的文档：</span><br><span class="line">&gt;db.col.remove(&#123;'title':'MongoDB 教程'&#125;)</span><br><span class="line">WriteResult(&#123; "nRemoved" : 2 &#125;) # 删除了两条数据</span><br><span class="line">&gt;db.col.find()</span><br><span class="line">…… # 没有数据</span><br></pre></td></tr></table></figure></p>
<p>如果你只想删除第一条找到的记录可以设置 justOne 为 1，如下所示：<br><figure class="highlight js"><figcaption><span>>db.COLLECTION_NAME.remove(DELETION_CRITERIA,1)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">如果你想删除所有数据，可以使用以下方式（类似常规 SQL 的 truncate 命令）：</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt;db.col.remove(&#123;&#125;)</span><br><span class="line">&gt;db.col.find()</span><br><span class="line">&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>MongoDB 查询文档<br>语法<br>MongoDB 查询数据的语法格式如下：<br><figure class="highlight js"><figcaption><span>>db.COLLECTION_NAME.find()```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">find() 方法以非结构化的方式来显示所有文档。</span><br><span class="line">如果你需要以易读的方式来读取数据，可以使用 pretty() 方法，语法格式如下：</span><br><span class="line">&gt;db.col.find().pretty()</span><br><span class="line">pretty() 方法以格式化的方式来显示所有文档。</span><br><span class="line">实例</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt; db.col.find().pretty()</span></span><br></pre></td></tr></table></figure></p>
<p>除了 find() 方法之外，还有一个 findOne() 方法，它只返回一个文档。</p>
<p>MongoDB 与 RDBMS Where 语句比较<br>如果你熟悉常规的 SQL 数据，通过下表可以更好的理解 MongoDB 的条件语句查询：<br>操作 格式 范例 RDBMS中的类似语句<br>等于 {:} db.col.find({“by”:”菜鸟教程”}).pretty() where by = ‘菜鸟教程’<br>小于 {:{$lt:}} db.col.find({“likes”:{$lt:50}}).pretty() where likes &lt; 50<br>小于或等于 {:{$lte:}} db.col.find({“likes”:{$lte:50}}).pretty() where likes &lt;= 50<br>大于 {:{$gt:}} db.col.find({“likes”:{$gt:50}}).pretty() where likes &gt; 50<br>大于或等于 {:{$gte:}} db.col.find({“likes”:{$gte:50}}).pretty() where likes &gt;= 50<br>不等于 {:{$ne:}} db.col.find({“likes”:{$ne:50}}).pretty() where likes != 50</p>
<p>MongoDB AND 条件<br>MongoDB 的 find() 方法可以传入多个键(key)，每个键(key)以逗号隔开，及常规 SQL 的 AND 条件。<br>语法格式如下：</p>
<blockquote>
<p>db.col.find({key1:value1, key2:value2}).pretty()<br>实例<br>以下实例通过 by 和 title 键来查询 菜鸟教程 中 MongoDB 教程 的数据<br><figure class="highlight js"><figcaption><span>> db.col.find(&#123;"by":"菜鸟教程", "title":"MongoDB 教程"&#125;).pretty()</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">"_id"</span> : ObjectId(<span class="string">"56063f17ade2f21f36b03133"</span>),</span><br><span class="line"><span class="string">"title"</span> : <span class="string">"MongoDB 教程"</span>,</span><br><span class="line"><span class="string">"description"</span> : <span class="string">"MongoDB 是一个 Nosql 数据库"</span>,</span><br><span class="line"><span class="string">"by"</span> : <span class="string">"菜鸟教程"</span>,</span><br><span class="line"><span class="string">"url"</span> : <span class="string">"http://www.runoob.com"</span>,</span><br><span class="line"><span class="string">"tags"</span> : [</span><br><span class="line"><span class="string">"mongodb"</span>,</span><br><span class="line"><span class="string">"database"</span>,</span><br><span class="line"><span class="string">"NoSQL"</span></span><br><span class="line">],</span><br><span class="line"><span class="string">"likes"</span> : <span class="number">100</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>以上实例中类似于 WHERE 语句：WHERE by=’菜鸟教程’ AND title=’MongoDB 教程’</p>
<p>MongoDB OR 条件<br>MongoDB OR 条件语句使用了关键字 $or,语法格式如下：<br><figure class="highlight js"><figcaption><span>>db.col.find(</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">$or: [</span><br><span class="line">&#123;key1: value1&#125;, &#123;key2:value2&#125;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br><span class="line">).pretty()</span><br></pre></td></tr></table></figure></p>
<p>实例<br>以下实例中，我们演示了查询键 by 值为 菜鸟教程 或键 title 值为 MongoDB 教程 的文档。<br><figure class="highlight js"><figcaption><span>>db.col.find(&#123;$or:[&#123;"by":"菜鸟教程"&#125;,&#123;"title": "MongoDB 教程"&#125;]&#125;).pretty()</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">"_id"</span> : ObjectId(<span class="string">"56063f17ade2f21f36b03133"</span>),</span><br><span class="line"><span class="string">"title"</span> : <span class="string">"MongoDB 教程"</span>,</span><br><span class="line"><span class="string">"description"</span> : <span class="string">"MongoDB 是一个 Nosql 数据库"</span>,</span><br><span class="line"><span class="string">"by"</span> : <span class="string">"菜鸟教程"</span>,</span><br><span class="line"><span class="string">"url"</span> : <span class="string">"http://www.runoob.com"</span>,</span><br><span class="line"><span class="string">"tags"</span> : [</span><br><span class="line"><span class="string">"mongodb"</span>,</span><br><span class="line"><span class="string">"database"</span>,</span><br><span class="line"><span class="string">"NoSQL"</span></span><br><span class="line">],</span><br><span class="line"><span class="string">"likes"</span> : <span class="number">100</span></span><br><span class="line">&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></p>
<p>AND 和 OR 联合使用<br>以下实例演示了 AND 和 OR 联合使用，类似常规 SQL 语句为： ‘where url=’<a href="http://www.runoob.com" target="_blank" rel="external">http://www.runoob.com</a>‘ AND (by = ‘菜鸟教程’ OR title = ‘MongoDB 教程’)’<br><figure class="highlight js"><figcaption><span>>db.col.find(&#123;"likes": &#123;$gt:50&#125;, $or: [&#123;"by": "菜鸟教程"&#125;,&#123;"title": "MongoDB 教程"&#125;]&#125;).pretty()</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">"_id"</span> : ObjectId(<span class="string">"56063f17ade2f21f36b03133"</span>),</span><br><span class="line"><span class="string">"title"</span> : <span class="string">"MongoDB 教程"</span>,</span><br><span class="line"><span class="string">"description"</span> : <span class="string">"MongoDB 是一个 Nosql 数据库"</span>,</span><br><span class="line"><span class="string">"by"</span> : <span class="string">"菜鸟教程"</span>,</span><br><span class="line"><span class="string">"url"</span> : <span class="string">"http://www.runoob.com"</span>,</span><br><span class="line"><span class="string">"tags"</span> : [</span><br><span class="line"><span class="string">"mongodb"</span>,</span><br><span class="line"><span class="string">"database"</span>,</span><br><span class="line"><span class="string">"NoSQL"</span></span><br><span class="line">],</span><br><span class="line"><span class="string">"likes"</span> : <span class="number">100</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>MongoDB 条件操作符</p>
<p>描述<br>条件操作符用于比较两个表达式并从mongoDB集合中获取数据。<br>在本章节中，我们将讨论如何在MongoDB中使用条件操作符。<br>MongoDB中条件操作符有：<br>(&gt;) 大于 - $gt<br>(&lt;) 小于 - $lt (&gt;=) 大于等于 - $gte<br>(&lt;= ) 小于等于 - $lte<br>我们使用的数据库名称为”runoob” 我们的集合名称为”col”，以下为我们插入的数据。<br>为了方便测试，我们可以先使用以下命令清空集合 “col” 的数据：<br><figure class="highlight js"><figcaption><span>db.col.remove(&#123;&#125;)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MongoDB (&gt;) 大于操作符 - $gt</span><br><span class="line">如果你想获取 <span class="string">"col"</span> 集合中 <span class="string">"likes"</span> 大于 <span class="number">100</span> 的数据，你可以使用以下命令：</span><br><span class="line"><span class="string">``</span><span class="string">`js db.col.find(&#123;"likes" : &#123;$gt : 100&#125;&#125;)</span></span><br></pre></td></tr></table></figure></p>
<p>类似于SQL语句：<br>Select * from col where likes &gt; 22;<br>输出结果：</p>
<blockquote>
<p>db.col.find({“likes” : {$gt : 100}})<br>{ “_id” : ObjectId(“56066542ade2f21f36b0313a”), “title” : “PHP 教程”, “description” : “PHP 是一种创建动态交互性站点的强有力的服务器端脚本语言。”, “by” : “菜鸟教程”, “url” : “<a href="http://www.runoob.com" target="_blank" rel="external">http://www.runoob.com</a>“, “tags” : [ “php” ], “likes” : 200 }<br>{ “_id” : ObjectId(“56066549ade2f21f36b0313b”), “title” : “Java 教程”, “description” : “Java 是由Sun Microsystems公司于1995年5月推出的高级程序设计语言。”, “by” : “菜鸟教程”, “url” : “<a href="http://www.runoob.com" target="_blank" rel="external">http://www.runoob.com</a>“, “tags” : [ “java” ], “likes” : 150 }</p>
</blockquote>
<p>MongoDB (&gt;) 大于操作符 - $gt<br>如果你想获取 “col” 集合中 “likes” 大于 100 的数据，你可以使用以下命令：<br><figure class="highlight js"><figcaption><span>db.col.find(&#123;"likes" : &#123;$gt : 100&#125;&#125;)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">类似于SQL语句：</span><br><span class="line"><span class="string">``</span><span class="string">`js Select * from col where likes &gt; 22;</span></span><br></pre></td></tr></table></figure></p>
<p>输出结果：<br><figure class="highlight js"><figcaption><span>> db.col.find(&#123;"likes" : &#123;$gt : 100&#125;&#125;)</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"56066542ade2f21f36b0313a"</span>), <span class="string">"title"</span> : <span class="string">"PHP 教程"</span>, <span class="string">"description"</span> : <span class="string">"PHP 是一种创建动态交互性站点的强有力的服务器端脚本语言。"</span>, <span class="string">"by"</span> : <span class="string">"菜鸟教程"</span>, <span class="string">"url"</span> : <span class="string">"http://www.runoob.com"</span>, <span class="string">"tags"</span> : [ <span class="string">"php"</span> ], <span class="string">"likes"</span> : <span class="number">200</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"56066549ade2f21f36b0313b"</span>), <span class="string">"title"</span> : <span class="string">"Java 教程"</span>, <span class="string">"description"</span> : <span class="string">"Java 是由Sun Microsystems公司于1995年5月推出的高级程序设计语言。"</span>, <span class="string">"by"</span> : <span class="string">"菜鸟教程"</span>, <span class="string">"url"</span> : <span class="string">"http://www.runoob.com"</span>, <span class="string">"tags"</span> : [ <span class="string">"java"</span> ], <span class="string">"likes"</span> : <span class="number">150</span> &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></p>
<p>MongoDB（&gt;=）大于等于操作符 - $gte<br>如果你想获取”col”集合中 “likes” 大于等于 100 的数据，你可以使用以下命令：<br><figure class="highlight js"><figcaption><span>db.col.find(&#123;likes : &#123;$gte : 100&#125;&#125;)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">类似于SQL语句：</span><br><span class="line">Select * <span class="keyword">from</span> col where likes &gt;=<span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">MongoDB (&amp;lt;) 小于操作符 - $lt</span><br><span class="line">如果你想获取<span class="string">"col"</span>集合中 <span class="string">"likes"</span> 小于 <span class="number">150</span> 的数据，你可以使用以下命令：</span><br><span class="line"><span class="string">``</span><span class="string">`js db.col.find(&#123;likes : &#123;$lt : 150&#125;&#125;)</span></span><br></pre></td></tr></table></figure></p>
<p>类似于SQL语句：<br>Select * from col where likes &lt; 150;</p>
<p>MongoDB (&lt;=) 小于操作符 - $lte<br>如果你想获取”col”集合中 “likes” 小于等于 150 的数据，你可以使用以下命令：<br><figure class="highlight js"><figcaption><span>db.col.find(&#123;likes : &#123;$lte : 150&#125;&#125;)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">类似于SQL语句：</span><br><span class="line">Select * <span class="keyword">from</span> col where likes &amp;lt;= <span class="number">150</span>;</span><br><span class="line"></span><br><span class="line">MongoDB 使用 (&amp;lt;) 和 (&gt;) 查询 - $lt 和 $gt</span><br><span class="line">如果你想获取<span class="string">"col"</span>集合中 <span class="string">"likes"</span> 大于<span class="number">100</span>，小于 <span class="number">200</span> 的数据，你可以使用以下命令：</span><br><span class="line"><span class="string">``</span><span class="string">`js db.col.find(&#123;likes : &#123;$lt :200, $gt : 100&#125;&#125;)</span></span><br></pre></td></tr></table></figure></p>
<p>类似于SQL语句：<br>Select * from col where likes&gt;100 AND likes&lt;200;</p>
<p>MongoDB $type 操作符</p>
<p>描述<br>在本章节中，我们将继续讨论MongoDB中条件操作符 $type。<br>$type操作符是基于BSON类型来检索集合中匹配的数据类型，并返回结果。<br>MongoDB 中可以使用的类型如下表所示：<br>我们使用的数据库名称为”runoob” 我们的集合名称为”col”，以下为我们插入的数据。<br>简单的集合”col”： 和条件操作符一样，在集合col中插入3个文档</p>
<p>MongoDB 操作符 - $type 实例<br>如果想获取 “col” 集合中 title 为 String 的数据，你可以使用以下命令：<br><figure class="highlight js"><figcaption><span>db.col.find(&#123;"title" : &#123;$type : 2&#125;&#125;)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Double <span class="number">1</span></span><br><span class="line"><span class="built_in">String</span> <span class="number">2</span></span><br><span class="line"><span class="built_in">Object</span> <span class="number">3</span></span><br><span class="line"><span class="built_in">Array</span> <span class="number">4</span></span><br><span class="line">Binary data <span class="number">5</span></span><br><span class="line">Undefined <span class="number">6</span> 已废弃。</span><br><span class="line"><span class="built_in">Object</span> id <span class="number">7</span></span><br><span class="line"><span class="built_in">Boolean</span> <span class="number">8</span></span><br><span class="line"><span class="built_in">Date</span> <span class="number">9</span></span><br><span class="line">Null <span class="number">10</span></span><br><span class="line">Regular Expression <span class="number">11</span></span><br><span class="line">JavaScript <span class="number">13</span></span><br><span class="line"><span class="built_in">Symbol</span> <span class="number">14</span></span><br><span class="line">JavaScript (<span class="keyword">with</span> scope) <span class="number">15</span></span><br><span class="line"><span class="number">32</span>-bit integer <span class="number">16</span></span><br><span class="line">Timestamp <span class="number">17</span></span><br><span class="line"><span class="number">64</span>-bit integer <span class="number">18</span></span><br><span class="line">Min key <span class="number">255</span> Query <span class="keyword">with</span> <span class="number">-1.</span></span><br><span class="line">Max key <span class="number">127</span></span><br><span class="line"></span><br><span class="line">MongoDB Limit与Skip方法</span><br><span class="line">MongoDB Limit() 方法</span><br><span class="line">如果你需要在MongoDB中读取指定数量的数据记录，可以使用MongoDB的Limit方法，limit()方法接受一个数字参数，该参数指定从MongoDB中读取的记录条数。</span><br><span class="line">语法</span><br><span class="line">limit()方法基本语法如下所示：</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt;db.COLLECTION_NAME.find().limit(NUMBER)</span></span><br></pre></td></tr></table></figure></p>
<p>以上实例为显示查询文档中的两条记录：<br><figure class="highlight js"><figcaption><span>> db.col.find(&#123;&#125;,&#123;"title":1,_id:0&#125;).limit(2)</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第一个&#123;&#125;是集合名，title后边的1是只显示title，默认是显示_id的，所以让他为0，这样他就不会显示了，limit是显示几个文档</span></span><br><span class="line">&#123; <span class="string">"title"</span> : <span class="string">"PHP 教程"</span> &#125;</span><br><span class="line">&#123; <span class="string">"title"</span> : <span class="string">"Java 教程"</span> &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></p>
<p>MongoDB Skip() 方法<br>我们除了可以使用limit()方法来读取指定数量的数据外，还可以使用skip()方法来跳过指定数量的数据，skip方法同样接受一个数字参数作为跳过的记录条数。<br>语法<br>skip() 方法脚本语法格式如下：<br><figure class="highlight js"><figcaption><span>>db.COLLECTION_NAME.find().limit(NUMBER).skip(NUMBER)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">实例</span><br><span class="line">以上实例只会显示第二条文档数据</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt;db.col.find(&#123;&#125;,&#123;"title":1,_id:0&#125;).limit(1).skip(1)</span><br><span class="line">&#123; "title" : "Java 教程" &#125;</span><br><span class="line">&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>MongoDB 排序<br>MongoDB sort()方法<br>在MongoDB中使用使用sort()方法对数据进行排序，sort()方法可以通过参数指定排序的字段，并使用 1 和 -1 来指定排序的方式，其中 1 为升序排列，而-1是用于降序排列。<br>语法<br>sort()方法基本语法如下所示：<br><figure class="highlight js"><figcaption><span>>db.COLLECTION_NAME.find().sort(&#123;KEY:1&#125;)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">以下实例演示了 col 集合中的数据按字段 likes 的降序排列：</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt;db.col.find(&#123;&#125;,&#123;"title":1,_id:0&#125;).sort(&#123;"likes":-1&#125;)</span><br><span class="line">&#123; "title" : "PHP 教程" &#125;</span><br><span class="line">&#123; "title" : "Java 教程" &#125;</span><br><span class="line">&#123; "title" : "MongoDB 教程" &#125;</span><br><span class="line">&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>实例<br>在后台创建索引：<br><figure class="highlight js"><figcaption><span>db.values.ensureIndex(&#123;open: 1, close: 1&#125;, &#123;background: true&#125;)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">其中open后的<span class="number">1</span>表示升序，如果是<span class="number">-1</span>则是降序，background是ensureIndex的可选参数，创建工作在后台运行</span><br><span class="line">通过在创建索引时加background:<span class="literal">true</span> 的选项，让创建工作在后台执行</span><br><span class="line"></span><br><span class="line">MongoDB 聚合</span><br><span class="line">MongoDB中聚合(aggregate)主要用于处理数据(诸如统计平均值,求和等)，并返回计算后的数据结果。有点类似sql语句中的 count(*)。</span><br><span class="line">aggregate() 方法</span><br><span class="line">MongoDB中聚合的方法使用aggregate()。</span><br><span class="line">语法</span><br><span class="line">aggregate() 方法的基本语法格式如下所示：</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt;db.COLLECTION_NAME.aggregate(AGGREGATE_OPERATION)</span></span><br></pre></td></tr></table></figure></p>
<p>现在我们通过以上集合计算每个作者所写的文章数，使用aggregate()计算结果如下：<br><figure class="highlight js"><figcaption><span>> db.mycol.aggregate([&#123;$group : &#123;_id : "$by_user", num_tutorial : &#123;$sum : 1&#125;&#125;&#125;])</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//$group是管道聚合有讲，通过by_user进行数据分组，num_tutorial这个是自定义的，$sum是说求和的意思</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"result"</span> : [ <span class="comment">//result固定格式</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"_id"</span> : <span class="string">"w3cschool.cc"</span>,</span><br><span class="line"><span class="string">"num_tutorial"</span> : <span class="number">2</span></span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"_id"</span> : <span class="string">"Neo4j"</span>,</span><br><span class="line"><span class="string">"num_tutorial"</span> : <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">],</span><br><span class="line"><span class="string">"ok"</span> : <span class="number">1</span> <span class="comment">//ok固定格式</span></span><br><span class="line">&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></p>
<p>管道的概念<br>管道在Unix和Linux中一般用于将当前命令的输出结果作为下一个命令的参数。<br>MongoDB的聚合管道将MongoDB文档在一个管道处理完毕后将结果传递给下一个管道处理。管道操作是可以重复的。<br>表达式：处理输入文档并输出。表达式是无状态的，只能用于计算当前聚合管道的文档，不能处理其它的文档。<br>这里我们介绍一下聚合框架中常用的几个操作：<br>$project：修改输入文档的结构。可以用来重命名、增加或删除域，也可以用于创建计算结果以及嵌套文档。<br>$match：用于过滤数据，只输出符合条件的文档。$match使用MongoDB的标准查询操作。<br>$limit：用来限制MongoDB聚合管道返回的文档数。<br>$skip：在聚合管道中跳过指定数量的文档，并返回余下的文档。<br>$unwind：将文档中的某一个数组类型字段拆分成多条，每条包含数组中的一个值。<br>$group：将集合中的文档分组，可用于统计结果。<br>$sort：将输入文档排序后输出。<br>$geoNear：输出接近某一地理位置的有序文档。<br>管道操作符实例</p>
<p>1、$project实例<br><figure class="highlight js"><figcaption><span>db.article.aggregate(</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123; $project : &#123;</span><br><span class="line">title : <span class="number">1</span> ,</span><br><span class="line">author : <span class="number">1</span> ,</span><br><span class="line">&#125;&#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<p>这样的话结果中就只还有_id,tilte和author三个字段了，默认情况下_id字段是被包含的，如果要想不包含_id话可以这样:<br><figure class="highlight js"><figcaption><span>db.article.aggregate(</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123; $project : &#123;</span><br><span class="line">_id : <span class="number">0</span> ,</span><br><span class="line">title : <span class="number">1</span> ,</span><br><span class="line">author : <span class="number">1</span></span><br><span class="line">&#125;&#125;);</span><br></pre></td></tr></table></figure></p>
<p>2.$match实例<br><figure class="highlight js"><figcaption><span>db.articles.aggregate( [</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123; $match : &#123; score : &#123; $gt : <span class="number">70</span>, $lte : <span class="number">90</span> &#125; &#125; &#125;,</span><br><span class="line">&#123; $group: &#123; _id: <span class="literal">null</span>, count: &#123; $sum: <span class="number">1</span> &#125; &#125; &#125;</span><br><span class="line">] );</span><br></pre></td></tr></table></figure></p>
<p>$match用于获取分数大于70小于或等于90记录，然后将符合条件的记录送到下一阶段$group管道操作符进行处理。<br>3.$skip实例<br><figure class="highlight js"><figcaption><span>db.article.aggregate(</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $skip : <span class="number">5</span> &#125;);</span><br></pre></td></tr></table></figure></p>
<p>经过$skip管道操作符处理后，前五个文档被”过滤”掉。</p>
<p>MongoDB 复制（副本集）<br>MongoDB复制是将数据同步在多个服务器的过程。<br>复制提供了数据的冗余备份，并在多个服务器上存储数据副本，提高了数据的可用性， 并可以保证数据的安全性。<br>复制还允许您从硬件故障和服务中断中恢复数据。<br>什么是复制?<br>保障数据的安全性<br>数据高可用性 (24*7)<br>灾难恢复<br>无需停机维护（如备份，重建索引，压缩）<br>分布式读取数据<br>MongoDB复制原理<br>mongodb的复制至少需要两个节点。其中一个是主节点，负责处理客户端请求，其余的都是从节点，负责复制主节点上的数据。<br>mongodb各个节点常见的搭配方式为：一主一从、一主多从。<br>主节点记录在其上的所有操作oplog，从节点定期轮询主节点获取这些操作，然后对自己的数据副本执行这些操作，从而保证从节点的数据与主节点一致。<br>MongoDB复制结构图如下所示：</p>
<p><img src="http://www.runoob.com/wp-content/uploads/2013/12/replication.png" alt="MongoDB复制结构图"><br>MongoDB复制结构图<br>以上结构图总，客户端总主节点读取数据，在客户端写入数据到主节点是， 主节点与从节点进行数据交互保障数据的一致性。<br>副本集特征：<br>N 个节点的集群<br>任何节点可作为主节点<br>所有写入操作都在主节点上<br>自动故障转移<br>自动恢复</p>
<p>MongoDB副本集设置<br>在本教程中我们使用同一个MongoDB来做MongoDB主从的实验， 操作步骤如下：<br>1、关闭正在运行的MongoDB服务器。<br>现在我们通过指定 –replSet 选项来启动mongoDB。–replSet 基本语法格式如下：<br><figure class="highlight js"><figcaption><span>mongod --port "PORT" --dbpath "YOUR_DB_DATA_PATH" --replSet "REPLICA_SET_INSTANCE_NAME"```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">实例</span><br><span class="line"><span class="string">``</span><span class="string">`js mongod --port 27017 --dbpath "D:\set up\mongodb\data" --replSet rs0</span></span><br></pre></td></tr></table></figure></p>
<p>以上实例会启动一个名为rs0的MongoDB实例，其端口号为27017。<br>启动后打开命令提示框并连接上mongoDB服务。<br>在Mongo客户端使用命令rs.initiate()来启动一个新的副本集。<br>我们可以使用rs.conf()来查看副本集的配置<br>查看副本集姿态使用 rs.status() 命令</p>
<p>副本集添加成员<br>添加副本集的成员，我们需要使用多条服务器来启动mongo服务。进入Mongo客户端，并使用rs.add()方法来添加副本集的成员。<br>语法<br>rs.add() 命令基本语法格式如下：<br><figure class="highlight js"><figcaption><span>>rs.add(HOST_NAME:PORT)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">实例</span><br><span class="line">假设你已经启动了一个名为mongod1.net，端口号为<span class="number">27017</span>的Mongo服务。 在客户端命令窗口使用rs.add() 命令将其添加到副本集中，命令如下所示：</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt;rs.add("mongod1.net:27017")</span><br><span class="line">&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>MongoDB中你只能通过主节点将Mongo服务添加到副本集中， 判断当前运行的Mongo服务是否为主节点可以使用命令db.isMaster() 。<br>MongoDB的副本集与我们常见的主从有所不同，主从在主机宕机后所有服务将停止，而副本集在主机宕机后，副本会接管主节点成为主节点，不会出现宕机的情况。</p>
<p>MongoDB 分片<br>分片<br>在Mongodb里面存在另一种集群，就是分片技术,可以满足MongoDB数据量大量增长的需求。<br>当MongoDB存储海量的数据时，一台机器可能不足以存储数据也足以提供可接受的读写吞吐量。这时，我们就可以通过在多台机器上分割数据，使得数据库系统能存储和处理更多的数据。<br>为什么使用分片<br>复制所有的写入操作到主节点<br>延迟的敏感数据会在主节点查询<br>单个副本集限制在12个节点<br>当请求量巨大时会出现内存不足。<br>本地磁盘不足<br>垂直扩展价格昂贵<br>MongoDB分片<br>下图展示了在MongoDB中使用分片集群结构分布：</p>
<p><img src="http://www.runoob.com/wp-content/uploads/2013/12/sharding.png" alt=""></p>
<p>上图中主要有如下所述三个主要组件：<br>Shard:<br>用于存储实际的数据块，实际生产环境中一个shard server角色可由几台机器组个一个relica set承担，防止主机单点故障<br>Config Server:<br>mongod实例，存储了整个 ClusterMetadata，其中包括 chunk信息。<br>Query Routers:<br>前端路由，客户端由此接入，且让整个集群看上去像单一数据库，前端应用可以透明使用。<br>分片实例（完全没看懂）<br>分片结构端口分布如下：<br>Shard Server 1：27020<br>Shard Server 2：27021<br>Shard Server 3：27022<br>Shard Server 4：27023<br>Config Server ：27100<br>Route Process：40000<br>步骤一：启动Shard Server<br>[root@100 /]# mkdir -p /www/mongoDB/shard/s0<br>[root@100 /]# mkdir -p /www/mongoDB/shard/s1<br>[root@100 /]# mkdir -p /www/mongoDB/shard/s2<br>[root@100 /]# mkdir -p /www/mongoDB/shard/s3<br>[root@100 /]# mkdir -p /www/mongoDB/shard/log<br>[root@100 /]# /usr/local/mongoDB/bin/mongod –port 27020 –dbpath=/www/mongoDB/shard/s0 –logpath=/www/mongoDB/shard/log/s0.log –logappend –fork<br>….<br>[root@100 /]# /usr/local/mongoDB/bin/mongod –port 27023 –dbpath=/www/mongoDB/shard/s3 –logpath=/www/mongoDB/shard/log/s3.log –logappend –fork<br>步骤二： 启动Config Server<br>[root@100 /]# mkdir -p /www/mongoDB/shard/config<br>[root@100 /]# /usr/local/mongoDB/bin/mongod –port 27100 –dbpath=/www/mongoDB/shard/config –logpath=/www/mongoDB/shard/log/config.log –logappend –fork<br>注意：这里我们完全可以像启动普通mongodb服务一样启动，不需要添加—shardsvr和configsvr参数。因为这两个参数的作用就是改变启动端口的，所以我们自行指定了端口就可以。<br>步骤三： 启动Route Process<br>/usr/local/mongoDB/bin/mongos –port 40000 –configdb localhost:27100 –fork –logpath=/www/mongoDB/shard/log/route.log –chunkSize 500<br>mongos启动参数中，chunkSize这一项是用来指定chunk的大小的，单位是MB，默认大小为200MB.<br>步骤四： 配置Sharding<br>接下来，我们使用MongoDB Shell登录到mongos，添加Shard节点<br>[root@100 shard]# /usr/local/mongoDB/bin/mongo admin –port 40000<br>MongoDB shell version: 2.0.7<br>connecting to: 127.0.0.1:40000/admin<br>mongos&gt; db.runCommand({ addshard:”localhost:27020” })<br>{ “shardAdded” : “shard0000”, “ok” : 1 }<br>……<br>mongos&gt; db.runCommand({ addshard:”localhost:27029” })<br>{ “shardAdded” : “shard0009”, “ok” : 1 }<br>mongos&gt; db.runCommand({ enablesharding:”test” }) #设置分片存储的数据库<br>{ “ok” : 1 }<br>mongos&gt; db.runCommand({ shardcollection: “test.log”, key: { id:1,time:1}})<br>{ “collectionsharded” : “test.log”, “ok” : 1 }<br>步骤五： 程序代码内无需太大更改，直接按照连接普通的mongo数据库那样，将数据库连接接入接口40000</p>
<p>MongoDB 备份(mongodump)与恢复(mongorerstore)<br>MongoDB数据备份<br>在Mongodb中我们使用mongodump命令来备份MongoDB数据。该命令可以导出所有数据到指定目录中。<br>mongodump命令可以通过参数指定导出的数据量级转存的服务器。<br>语法<br>mongodump命令脚本语法如下：<br><figure class="highlight js"><figcaption><span>>mongodump -h dbhost -d dbname -o dbdirectory```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-h：</span><br><span class="line">MongDB所在服务器地址，例如：<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>，当然也可以指定端口号：<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">27017</span></span><br><span class="line">-d：</span><br><span class="line">需要备份的数据库实例，例如：test</span><br><span class="line">-o：</span><br><span class="line">备份的数据存放位置，例如：c:\data\dump，当然该目录需要提前建立，在备份完成后，系统自动在dump目录下建立一个test目录，这个目录里面存放该数据库实例的备份数据。</span><br><span class="line">实例</span><br><span class="line">在本地使用 <span class="number">27017</span> 启动你的mongod服务。打开命令提示符窗口，进入MongoDB安装目录的bin目录输入命令mongodump:</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt;mongodump</span></span><br></pre></td></tr></table></figure></p>
<p>MongoDB数据恢复<br>mongodb使用 mongorerstore 命令来恢复备份的数据。<br>语法<br>mongorestore命令脚本语法如下：<br><figure class="highlight js"><figcaption><span>>mongorestore -h dbhost -d dbname --directoryperdb dbdirectory```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-h：</span><br><span class="line">MongoDB所在服务器地址</span><br><span class="line">-d：</span><br><span class="line">需要恢复的数据库实例，例如：test，当然这个名称也可以和备份时候的不一样，比如test2</span><br><span class="line">--directoryperdb：</span><br><span class="line">备份数据所在位置，例如：c:\data\dump\test，这里为什么要多加一个test，而不是备份时候的dump，读者自己查看提示吧！</span><br><span class="line">--drop：</span><br><span class="line">恢复的时候，先删除当前数据，然后恢复备份的数据。就是说，恢复后，备份后添加修改的数据都会被删除，慎用哦！</span><br><span class="line">接下来我们执行以下命令:</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt;mongorestore</span></span><br></pre></td></tr></table></figure></p>
<p>MongoDB 监控<br>在你已经安装部署并允许MongoDB服务后，你必须要了解MongoDB的运行情况，并查看MongoDB的性能。这样在大流量得情况下可以很好的应对并保证MongoDB正常运作。<br>MongoDB中提供了mongostat 和 mongotop 两个命令来监控MongoDB的运行情况。<br>mongostat 命令<br>mongostat是mongodb自带的状态检测工具，在命令行下使用。它会间隔固定时间获取mongodb的当前运行状态，并输出。如果你发现数据库突然变慢或者有其他问题的话，你第一手的操作就考虑采用mongostat来查看mongo的状态。<br>启动你的Mongod服务，进入到你安装的MongoDB目录下的bin目录， 然后输入mongostat命令，如下所示：<br><figure class="highlight js"><figcaption><span>D:\set up\mongodb\bin>mongostat```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mongotop 命令</span><br><span class="line">mongotop也是mongodb下的一个内置工具，mongotop提供了一个方法，用来跟踪一个MongoDB的实例，查看哪些大量的时间花费在读取和写入数据。 mongotop提供每个集合的水平的统计数据。默认情况下，mongotop返回值的每一秒。</span><br><span class="line">启动你的Mongod服务，进入到你安装的MongoDB目录下的bin目录， 然后输入mongotop命令，如下所示：</span><br><span class="line"><span class="string">``</span><span class="string">`js D:\set up\mongodb\bin&gt;mongotop</span></span><br></pre></td></tr></table></figure></p>
<p>带参数实例<br><figure class="highlight js"><figcaption><span>E:\mongodb-win32-x86_64-2.2.1\bin>mongotop 10```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">后面的<span class="number">10</span>是参数 ，可以不使用，等待的时间长度，以秒为单位，mongotop等待调用之间。通过的默认mongotop返回数据的每一秒。</span><br><span class="line"><span class="string">``</span><span class="string">`js E:\mongodb-win32-x86_64-2.2.1\bin&gt;mongotop --locks</span></span><br></pre></td></tr></table></figure></p>
<p>报告每个数据库的锁的使用中，使用mongotop - 锁</p>
<p>输出结果字段说明：<br>ns：<br>包含数据库命名空间，后者结合了数据库名称和集合。<br>db：<br>包含数据库的名称。名为 . 的数据库针对全局锁定，而非特定数据库。<br>total：<br>mongod花费的时间工作在这个命名空间提供总额。<br>read：<br>提供了大量的时间，这mongod花费在执行读操作，在此命名空间。<br>write：<br>提供这个命名空间进行写操作，这mongod花了大量的时间。</p>
<p>MongoDB 关系<br>MongoDB 的关系表示多个文档之间在逻辑上的相互联系。<br>文档间可以通过嵌入和引用来建立联系。<br>MongoDB 中的关系可以是：<br>1:1 (1对1)<br>1: N (1对多)<br>N: 1 (多对1)<br>N: N (多对多)<br>接下来我们来考虑下用户与用户地址的关系。<br>一个用户可以有多个地址，所以是一对多的关系。<br>以下是 user 文档的简单结构：<br><figure class="highlight js"><figcaption><span>&#123;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"_id"</span>:ObjectId(<span class="string">"52ffc33cd85242f436000001"</span>),</span><br><span class="line"><span class="string">"name"</span>: <span class="string">"Tom Hanks"</span>,</span><br><span class="line"><span class="string">"contact"</span>: <span class="string">"987654321"</span>,</span><br><span class="line"><span class="string">"dob"</span>: <span class="string">"01-01-1991"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以下是 address 文档的简单结构：<br><figure class="highlight js"><figcaption><span>&#123;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"_id"</span>:ObjectId(<span class="string">"52ffc4a5d85242602e000000"</span>),</span><br><span class="line"><span class="string">"building"</span>: <span class="string">"22 A, Indiana Apt"</span>,</span><br><span class="line"><span class="string">"pincode"</span>: <span class="number">123456</span>,</span><br><span class="line"><span class="string">"city"</span>: <span class="string">"Los Angeles"</span>,</span><br><span class="line"><span class="string">"state"</span>: <span class="string">"California"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>嵌入式关系<br>使用嵌入式方法，我们可以把用户地址嵌入到用户的文档中：<br><figure class="highlight js"><figcaption><span>"_id":ObjectId("52ffc33cd85242f436000001"),</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"contact"</span>: <span class="string">"987654321"</span>,</span><br><span class="line"><span class="string">"dob"</span>: <span class="string">"01-01-1991"</span>,</span><br><span class="line"><span class="string">"name"</span>: <span class="string">"Tom Benzamin"</span>,</span><br><span class="line"><span class="string">"address"</span>: [</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"building"</span>: <span class="string">"22 A, Indiana Apt"</span>,</span><br><span class="line"><span class="string">"pincode"</span>: <span class="number">123456</span>,</span><br><span class="line"><span class="string">"city"</span>: <span class="string">"Los Angeles"</span>,</span><br><span class="line"><span class="string">"state"</span>: <span class="string">"California"</span></span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"building"</span>: <span class="string">"170 A, Acropolis Apt"</span>,</span><br><span class="line"><span class="string">"pincode"</span>: <span class="number">456789</span>,</span><br><span class="line"><span class="string">"city"</span>: <span class="string">"Chicago"</span>,</span><br><span class="line"><span class="string">"state"</span>: <span class="string">"Illinois"</span></span><br><span class="line">&#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上数据保存在单一的文档中，可以比较容易的获取很维护数据。 你可以这样查询用户的地址：<br><figure class="highlight js"><figcaption><span>>db.users.findOne(&#123;"name":"Tom Benzamin"&#125;,&#123;"address":1&#125;)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">注意：以上查询中 db 和 users 表示数据库和集合。</span><br><span class="line">这种数据结构的缺点是，如果用户和用户地址在不断增加，数据量不断变大，会影响读写性能。</span><br><span class="line"></span><br><span class="line">引用式关系</span><br><span class="line">引用式关系是设计数据库时经常用到的方法，这种方法把用户数据文档和用户地址数据文档分开，通过引用文档的 id 字段来建立关系。</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"_id"</span>:ObjectId(<span class="string">"52ffc33cd85242f436000001"</span>),</span><br><span class="line"><span class="string">"contact"</span>: <span class="string">"987654321"</span>,</span><br><span class="line"><span class="string">"dob"</span>: <span class="string">"01-01-1991"</span>,</span><br><span class="line"><span class="string">"name"</span>: <span class="string">"Tom Benzamin"</span>,</span><br><span class="line"><span class="string">"address_ids"</span>: [</span><br><span class="line">ObjectId(<span class="string">"52ffc4a5d85242602e000000"</span>),</span><br><span class="line">ObjectId(<span class="string">"52ffc4a5d85242602e000001"</span>)</span><br><span class="line">]</span><br><span class="line">&#125;</span><br><span class="line">以上实例中，用户文档的 address_ids 字段包含用户地址的对象id（ObjectId）数组。</span><br><span class="line">我们可以读取这些用户地址的对象id（ObjectId）来获取用户的详细地址信息。</span><br><span class="line">这种方法需要两次查询，第一次查询用户地址的对象id（ObjectId），第二次通过查询的id获取用户的详细地址信息。</span><br><span class="line">&gt;<span class="keyword">var</span> result = db.users.findOne(&#123;<span class="string">"name"</span>:<span class="string">"Tom Benzamin"</span>&#125;,&#123;<span class="string">"address_ids"</span>:<span class="number">1</span>&#125;)</span><br><span class="line">&gt;<span class="keyword">var</span> addresses = db.address.find(&#123;<span class="string">"_id"</span>:&#123;<span class="string">"$in"</span>:result[<span class="string">"address_ids"</span>]&#125;&#125;)</span><br><span class="line"></span><br><span class="line">MongoDB 数据库引用</span><br><span class="line">在上一章节MongoDB关系中我们提到了MongoDB的引用来规范数据结构文档。</span><br><span class="line">MongoDB 引用有两种：</span><br><span class="line">手动引用（Manual References）</span><br><span class="line">DBRefs</span><br><span class="line">DBRefs vs 手动引用</span><br><span class="line">考虑这样的一个场景，我们在不同的集合中 (address_home, address_office, address_mailing, 等)存储不同的地址（住址，办公室地址，邮件地址等）。</span><br><span class="line">这样，我们在调用不同地址时，也需要指定集合，一个文档从多个集合引用文档，我们应该使用 DBRefs。</span><br><span class="line">使用 DBRefs</span><br><span class="line">DBRef的形式：</span><br><span class="line"><span class="string">``</span><span class="string">`js &#123; $ref : , $id : , $db : &#125;</span></span><br></pre></td></tr></table></figure></p>
<p>三个字段表示的意义为：<br>$ref：集合名称<br>$id：引用的id<br>$db:数据库名称，可选参数<br>以下实例中用户数据文档使用了 DBRef, 字段 address：<br><figure class="highlight js"><figcaption><span>&#123;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"_id"</span>:ObjectId(<span class="string">"53402597d852426020000002"</span>),</span><br><span class="line"><span class="string">"address"</span>: &#123;</span><br><span class="line"><span class="string">"$ref"</span>: <span class="string">"address_home"</span>,</span><br><span class="line"><span class="string">"$id"</span>: ObjectId(<span class="string">"534009e4d852427820000002"</span>),</span><br><span class="line"><span class="string">"$db"</span>: <span class="string">"w3cschoolcc"</span>&#125;,</span><br><span class="line"><span class="string">"contact"</span>: <span class="string">"987654321"</span>,</span><br><span class="line"><span class="string">"dob"</span>: <span class="string">"01-01-1991"</span>,</span><br><span class="line"><span class="string">"name"</span>: <span class="string">"Tom Benzamin"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>address DBRef 字段指定了引用的地址文档是在 address_home 集合下的 w3cschoolcc 数据库，id 为 534009e4d852427820000002。<br>以下代码中，我们通过指定 $ref 参数（address_home 集合）来查找集合中指定id的用户地址信息：</p>
<blockquote>
<p>var user = db.users.findOne({“name”:”Tom Benzamin”})<br>var dbRef = user.address<br>db[dbRef.$ref].findOne({“_id”:(dbRef.$id)})<br>以上实例返回了 address_home 集合中的地址数据：<br><figure class="highlight js"><figcaption><span>&#123;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"_id"</span> : ObjectId(<span class="string">"534009e4d852427820000002"</span>),</span><br><span class="line"><span class="string">"building"</span> : <span class="string">"22 A, Indiana Apt"</span>,</span><br><span class="line"><span class="string">"pincode"</span> : <span class="number">123456</span>,</span><br><span class="line"><span class="string">"city"</span> : <span class="string">"Los Angeles"</span>,</span><br><span class="line"><span class="string">"state"</span> : <span class="string">"California"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>MongoDB 覆盖索引查询<br>官方的MongoDB的文档中说明，覆盖查询是以下的查询：<br>所有的查询字段是索引的一部分<br>所有的查询返回字段在同一个索引中<br>由于所有出现在查询中的字段是索引的一部分， MongoDB 无需在整个数据文档中检索匹配查询条件和返回使用相同索引的查询结果。<br>因为索引存在于RAM中，从索引中获取数据比通过扫描文档读取数据要快得多。<br>使用覆盖索引查询<br>为了测试盖索引查询，使用以下 users 集合:<br><figure class="highlight js"><figcaption><span>&#123;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"_id"</span>: ObjectId(<span class="string">"53402597d852426020000002"</span>),</span><br><span class="line"><span class="string">"contact"</span>: <span class="string">"987654321"</span>,</span><br><span class="line"><span class="string">"dob"</span>: <span class="string">"01-01-1991"</span>,</span><br><span class="line"><span class="string">"gender"</span>: <span class="string">"M"</span>,</span><br><span class="line"><span class="string">"name"</span>: <span class="string">"Tom Benzamin"</span>,</span><br><span class="line"><span class="string">"user_name"</span>: <span class="string">"tombenzamin"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们在 users 集合中创建联合索引，字段为 gender 和 user_name :</p>
<blockquote>
<p>db.users.ensureIndex({gender:1,user_name:1})<br>现在，该索引会覆盖以下查询：<br><figure class="highlight js"><figcaption><span>>db.users.find(&#123;gender:"M"&#125;,&#123;user_name:1,_id:0&#125;)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">也就是说，对于上述查询，MongoDB的不会去数据库文件中查找。相反，它会从索引中提取数据，这是非常快速的数据查询。</span><br><span class="line">由于我们的索引中不包括 _id 字段，_id在查询中会默认返回，我们可以在MongoDB的查询结果集中排除它。</span><br><span class="line">下面的实例没有排除_id，查询就不会被覆盖：</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt;db.users.find(&#123;gender:"M"&#125;,&#123;user_name:1&#125;)</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>最后，如果是以下的查询，不能使用覆盖索引查询：<br>所有索引字段是一个数组<br>所有索引字段是一个子文档</p>
<p>MongoDB 查询分析<br>MongoDB 查询分析可以确保我们建议的索引是否有效，是查询语句性能分析的重要工具。<br>MongoDB 查询分析常用函数有：explain() 和 hint()。<br>使用 explain()<br>explain 操作提供了查询信息，使用索引及查询统计等。有利于我们对索引的优化。<br>接下来我们在 users 集合中创建 gender 和 user_name 的索引：<br><figure class="highlight js"><figcaption><span>>db.users.ensureIndex(&#123;gender:1,user_name:1&#125;)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">现在在查询语句中使用 explain ：</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt;db.users.find(&#123;gender:"M"&#125;,&#123;user_name:1,_id:0&#125;).explain()</span></span><br></pre></td></tr></table></figure></p>
<p>以上的 explain() 查询返回如下结果：<br><figure class="highlight js"><figcaption><span>&#123;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"cursor"</span> : <span class="string">"BtreeCursor gender_1_user_name_1"</span>,</span><br><span class="line"><span class="string">"isMultiKey"</span> : <span class="literal">false</span>,</span><br><span class="line"><span class="string">"n"</span> : <span class="number">1</span>,</span><br><span class="line"><span class="string">"nscannedObjects"</span> : <span class="number">0</span>,</span><br><span class="line"><span class="string">"nscanned"</span> : <span class="number">1</span>,</span><br><span class="line"><span class="string">"nscannedObjectsAllPlans"</span> : <span class="number">0</span>,</span><br><span class="line"><span class="string">"nscannedAllPlans"</span> : <span class="number">1</span>,</span><br><span class="line"><span class="string">"scanAndOrder"</span> : <span class="literal">false</span>,</span><br><span class="line"><span class="string">"indexOnly"</span> : <span class="literal">true</span>,</span><br><span class="line"><span class="string">"nYields"</span> : <span class="number">0</span>,</span><br><span class="line"><span class="string">"nChunkSkips"</span> : <span class="number">0</span>,</span><br><span class="line"><span class="string">"millis"</span> : <span class="number">0</span>,</span><br><span class="line"><span class="string">"indexBounds"</span> : &#123;</span><br><span class="line"><span class="string">"gender"</span> : [</span><br><span class="line">[</span><br><span class="line"><span class="string">"M"</span>,</span><br><span class="line"><span class="string">"M"</span></span><br><span class="line">]</span><br><span class="line">],</span><br><span class="line"><span class="string">"user_name"</span> : [</span><br><span class="line">[</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"$minElement"</span> : <span class="number">1</span></span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"$maxElement"</span> : <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>现在，我们看看这个结果集的字段：<br>indexOnly: 字段为 true ，表示我们使用了索引。<br>cursor：因为这个查询使用了索引，MongoDB中索引存储在B树结构中，所以这是也使用了BtreeCursor类型的游标。如果没有使用索引，游标的类型是BasicCursor。这个键还会给出你所使用的索引的名称，你通过这个名称可以查看当前数据库下的system.indexes集合（系统自动创建，由于存储索引信息，这个稍微会提到）来得到索引的详细信息。<br>n：当前查询返回的文档数量。<br>nscanned/nscannedObjects：表明当前这次查询一共扫描了集合中多少个文档，我们的目的是，让这个数值和返回文档的数量越接近越好。<br>millis：当前查询所需时间，毫秒数。<br>indexBounds：当前查询具体使用的索引。<br>使用 hint()<br>虽然MongoDB查询优化器一般工作的很不错，但是也可以使用hints来强迫MongoDB使用一个指定的索引。<br>这种方法某些情形下会提升性能。 一个有索引的collection并且执行一个多字段的查询(一些字段已经索引了)。<br>如下查询实例指定了使用 gender 和 user_name 索引字段来查询：<br><figure class="highlight js"><figcaption><span>>db.users.find(&#123;gender:"M"&#125;,&#123;user_name:1,_id:0&#125;).hint(&#123;gender:1,user_name:1&#125;)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">可以使用 explain() 函数来分析以上查询：</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt;db.users.find(&#123;gender:"M"&#125;,&#123;user_name:1,_id:0&#125;).hint(&#123;gender:1,user_name:1&#125;).explain()</span></span><br></pre></td></tr></table></figure></p>
<p>MongoDB 原子操作<br>mongodb不支持事务，所以，在你的项目中应用时，要注意这点。无论什么设计，都不要要求mongodb保证数据的完整性。<br>但是mongodb提供了许多原子操作，比如文档的保存，修改，删除等，都是原子操作。<br>所谓原子操作就是要么这个文档保存到Mongodb，要么没有保存到Mongodb，不会出现查询到的文档没有保存完整的情况。<br>原子操作数据模型<br>考虑下面的例子，图书馆的书籍及结账信息。<br>实例说明了在一个相同的文档中如何确保嵌入字段关联原子操作（update：更新）的字段是同步的。<br><figure class="highlight js"><figcaption><span>book = &#123;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">_id: <span class="number">123456789</span>,</span><br><span class="line">title: <span class="string">"MongoDB: The Definitive Guide"</span>,</span><br><span class="line">author: [ <span class="string">"Kristina Chodorow"</span>, <span class="string">"Mike Dirolf"</span> ],</span><br><span class="line">published_date: ISODate(<span class="string">"2010-09-24"</span>),</span><br><span class="line">pages: <span class="number">216</span>,</span><br><span class="line">language: <span class="string">"English"</span>,</span><br><span class="line">publisher_id: <span class="string">"oreilly"</span>,</span><br><span class="line">available: <span class="number">3</span>,</span><br><span class="line">checkout: [ &#123; by: <span class="string">"joe"</span>, date: ISODate(<span class="string">"2012-10-15"</span>) &#125; ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>你可以使用 db.collection.findAndModify() 方法来判断书籍是否可结算并更新新的结算信息。<br>在同一个文档中嵌入的 available 和 checkout 字段来确保这些字段是同步更新的:<br><figure class="highlight js"><figcaption><span>db.books.findAndModify ( &#123;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">query: &#123;</span><br><span class="line">_id: <span class="number">123456789</span>,</span><br><span class="line">available: &#123; $gt: <span class="number">0</span> &#125;</span><br><span class="line">&#125;,</span><br><span class="line">update: &#123;</span><br><span class="line">$inc: &#123; available: <span class="number">-1</span> &#125;,</span><br><span class="line">$push: &#123; checkout: &#123; by: <span class="string">"abc"</span>, date: <span class="keyword">new</span> <span class="built_in">Date</span>() &#125; &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125; )</span><br></pre></td></tr></table></figure></p>
<p>原子操作常用命令<br><figure class="highlight js"><figcaption><span>$set```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">用来指定一个键并更新键值，若键不存在并创建。</span><br><span class="line">&#123; $set : &#123; field : value &#125; &#125;</span><br><span class="line">$unset</span><br><span class="line">用来删除一个键。</span><br><span class="line"><span class="string">``</span><span class="string">`js &#123; $unset : &#123; field : 1&#125; &#125;</span></span><br></pre></td></tr></table></figure></p>
<p>$inc<br>$inc可以对文档的某个值为数字型（只能为满足要求的数字）的键进行增减的操作。<br><figure class="highlight js"><figcaption><span>&#123; $inc : &#123; field : value &#125; &#125;```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$push</span><br><span class="line">用法：</span><br><span class="line"><span class="string">``</span><span class="string">`js &#123; $push : &#123; field : value &#125; &#125;</span></span><br></pre></td></tr></table></figure></p>
<p>把value追加到field里面去，field一定要是数组类型才行，如果field不存在，会新增一个数组类型加进去。<br>$pushAll<br>同$push,只是一次可以追加多个值到一个数组字段内。<br><figure class="highlight js"><figcaption><span>&#123; $pushAll : &#123; field : value_array &#125; &#125;```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$pull</span><br><span class="line">从数组field内删除一个等于value值。</span><br><span class="line"><span class="string">``</span><span class="string">`js &#123; $pull : &#123; field : _value &#125; &#125;</span></span><br></pre></td></tr></table></figure></p>
<p>$addToSet<br>增加一个值到数组内，而且只有当这个值不在数组内才增加。<br>$pop<br>删除数组的第一个或最后一个元素<br><figure class="highlight js"><figcaption><span>&#123; $pop : &#123; field : 1 &#125; &#125;```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$rename</span><br><span class="line">修改字段名称</span><br><span class="line"><span class="string">``</span><span class="string">`js &#123; $rename : &#123; old_field_name : new_field_name &#125; &#125;</span></span><br></pre></td></tr></table></figure></p>
<p>$bit<br>位操作，integer类型<br><figure class="highlight js"><figcaption><span>&#123;$bit : &#123; field : &#123;and : 5&#125;&#125;&#125;```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">偏移操作符</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt; t.find() &#123; "_id" : ObjectId("4b97e62bf1d8c7152c9ccb74"), "title" : "ABC", "comments" : [ &#123; "by" : "joe", "votes" : 3 &#125;, &#123; "by" : "jane", "votes" : 7 &#125; ] &#125;</span><br><span class="line"></span><br><span class="line">&gt; t.update( &#123;'comments.by':'joe'&#125;, &#123;$inc:&#123;'comments.$.votes':1&#125;&#125;, false, true )</span><br><span class="line"></span><br><span class="line">&gt; t.find() &#123; "_id" : ObjectId("4b97e62bf1d8c7152c9ccb74"), "title" : "ABC", "comments" : [ &#123; "by" : "joe", "votes" : 4 &#125;, &#123; "by" : "jane", "votes" : 7 &#125; ] &#125;</span></span><br></pre></td></tr></table></figure></p>
<p>MongoDB 高级索引<br>考虑以下文档集合（users ）:<br><figure class="highlight js"><figcaption><span>&#123;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"address"</span>: &#123;</span><br><span class="line"><span class="string">"city"</span>: <span class="string">"Los Angeles"</span>,</span><br><span class="line"><span class="string">"state"</span>: <span class="string">"California"</span>,</span><br><span class="line"><span class="string">"pincode"</span>: <span class="string">"123"</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">"tags"</span>: [</span><br><span class="line"><span class="string">"music"</span>,</span><br><span class="line"><span class="string">"cricket"</span>,</span><br><span class="line"><span class="string">"blogs"</span></span><br><span class="line">],</span><br><span class="line"><span class="string">"name"</span>: <span class="string">"Tom Benzamin"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上文档包含了 address 子文档和 tags 数组。<br>索引数组字段<br>假设我们基于标签来检索用户，为此我们需要对集合中的数组 tags 建立索引。<br>在数组中创建索引，需要对数组中的每个字段依次建立索引。所以在我们为数组 tags 创建索引时，会为 music、cricket、blogs三个值建立单独的索引。<br>使用以下命令创建数组索引：<br><figure class="highlight js"><figcaption><span>>db.users.ensureIndex(&#123;"tags":1&#125;)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">创建索引后，我们可以这样检索集合的 tags 字段：</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt;db.users.find(&#123;tags:"cricket"&#125;)</span></span><br></pre></td></tr></table></figure></p>
<p>为了验证我们使用使用了索引，可以使用 explain 命令：<br><figure class="highlight js"><figcaption><span>>db.users.find(&#123;tags:"cricket"&#125;).explain()```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">以上命令执行结果中会显示 <span class="string">"cursor"</span> : <span class="string">"BtreeCursor tags_1"</span> ，则表示已经使用了索引。</span><br><span class="line">索引子文档字段</span><br><span class="line">假设我们需要通过city、state、pincode字段来检索文档，由于这些字段是子文档的字段，所以我们需要对子文档建立索引。</span><br><span class="line">为子文档的三个字段创建索引，命令如下：</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt;db.users.ensureIndex(&#123;"address.city":1,"address.state":1,"address.pincode":1&#125;)</span></span><br></pre></td></tr></table></figure></p>
<p>一旦创建索引，我们可以使用子文档的字段来检索数据：<br><figure class="highlight js"><figcaption><span>>db.users.find(&#123;"address.city":"Los Angeles"&#125;)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">记住查询表达式必须遵循指定的索引的顺序。所以上面创建的索引将支持以下查询：</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt;db.users.find(&#123;"address.city":"Los Angeles","address.state":"California"&#125;)</span></span><br></pre></td></tr></table></figure></p>
<p>同样支持以下查询：<br><figure class="highlight js"><figcaption><span>>db.users.find(&#123;"address.city":"LosAngeles","address.state":"California","address.pincode":"123"&#125;)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">MongoDB 索引限制</span><br><span class="line">额外开销</span><br><span class="line">每个索引占据一定的存储空间，在进行插入，更新和删除操作时也需要对索引进行操作。所以，如果你很少对集合进行读取操作，建议不使用索引。</span><br><span class="line">内存(RAM)使用</span><br><span class="line">由于索引是存储在内存(RAM)中,你应该确保该索引的大小不超过内存的限制。</span><br><span class="line">如果索引的大小大于内存的限制，MongoDB会删除一些索引，这将导致性能下降。</span><br><span class="line">查询限制</span><br><span class="line">索引不能被以下的查询使用：</span><br><span class="line">正则表达式及非操作符，如 $nin, $not, 等。</span><br><span class="line">算术运算符，如 $mod, 等。</span><br><span class="line">$where 子句</span><br><span class="line">所以，检测你的语句是否使用索引是一个好的习惯，可以用explain来查看。</span><br><span class="line">索引键限制</span><br><span class="line">从<span class="number">2.6</span>版本开始，如果现有的索引字段的值超过索引键的限制，MongoDB中不会创建索引。</span><br><span class="line">插入文档超过索引键限制</span><br><span class="line">如果文档的索引字段值超过了索引键的限制，MongoDB不会将任何文档转换成索引的集合。与mongorestore和mongoimport工具类似。</span><br><span class="line">最大范围</span><br><span class="line">集合中索引不能超过<span class="number">64</span>个</span><br><span class="line">索引名的长度不能超过<span class="number">125</span>个字符</span><br><span class="line">一个复合索引最多可以有<span class="number">31</span>个字段</span><br><span class="line"></span><br><span class="line">MongoDB ObjectId</span><br><span class="line">在前面几个章节中我们已经使用了MongoDB 的对象 Id(ObjectId)。</span><br><span class="line">在本章节中，我们将了解的ObjectId的结构。</span><br><span class="line">ObjectId 是一个<span class="number">12</span>字节 BSON 类型数据，有以下格式：</span><br><span class="line">前<span class="number">4</span>个字节表示时间戳</span><br><span class="line">接下来的<span class="number">3</span>个字节是机器标识码</span><br><span class="line">紧接的两个字节由进程id组成（PID）</span><br><span class="line">最后三个字节是随机数。</span><br><span class="line">MongoDB中存储的文档必须有一个<span class="string">"_id"</span>键。这个键的值可以是任何类型的，默认是个ObjectId对象。</span><br><span class="line">在一个集合里面，每个集合都有唯一的<span class="string">"_id"</span>值，来确保集合里面每个文档都能被唯一标识。</span><br><span class="line">MongoDB采用ObjectId，而不是其他比较常规的做法（比如自动增加的主键）的主要原因，因为在多个 服务器上同步自动增加主键值既费力还费时。</span><br><span class="line">创建信的ObjectId</span><br><span class="line">使用以下代码生成新的ObjectId：</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt;newObjectId = ObjectId()</span></span><br></pre></td></tr></table></figure></p>
<p>上面的语句返回以下唯一生成的id：<br><figure class="highlight js"><figcaption><span>ObjectId("5349b4ddd2781d08c09890f3")```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">你也可以使用生成的id来取代MongoDB自动生成的ObjectId：</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt;myObjectId = ObjectId("5349b4ddd2781d08c09890f4")</span></span><br></pre></td></tr></table></figure></p>
<p>创建文档的时间戳<br>由于 ObjectId 中存储了 4 个字节的时间戳，所以你不需要为你的文档保存时间戳字段，你可以通过 getTimestamp 函数来获取文档的创建时间:<br><figure class="highlight js"><figcaption><span>>ObjectId("5349b4ddd2781d08c09890f4").getTimestamp()```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">以上代码将返回 ISO 格式的文档创建时间：</span><br><span class="line"><span class="string">``</span><span class="string">`js ISODate("2014-04-12T21:49:17Z")</span></span><br></pre></td></tr></table></figure></p>
<p>ObjectId 转换为字符串<br>在某些情况下，您可能需要将ObjectId转换为字符串格式。你可以使用下面的代码：<br><figure class="highlight js"><figcaption><span>>new ObjectId.str```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">以上代码将返回Guid格式的字符串：：</span><br><span class="line"><span class="string">``</span><span class="string">`js 5349b4ddd2781d08c09890f3</span></span><br></pre></td></tr></table></figure></p>
<p>MongoDB Map Reduce<br>Map-Reduce是一种计算模型，简单的说就是将大批量的工作（数据）分解（MAP）执行，然后再将结果合并成最终结果（REDUCE）。<br>MongoDB提供的Map-Reduce非常灵活，对于大规模数据分析也相当实用。<br>MapReduce 命令<br>以下是MapReduce的基本语法：<br><figure class="highlight js"><figcaption><span>>db.collection.mapReduce(</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;emit(key,value);&#125;, <span class="comment">//map 函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">key,values</span>) </span>&#123;<span class="keyword">return</span> reduceFunction&#125;, <span class="comment">//reduce 函数</span></span><br><span class="line">&#123;</span><br><span class="line">out: collection,</span><br><span class="line">query: <span class="built_in">document</span>,</span><br><span class="line">sort: <span class="built_in">document</span>,</span><br><span class="line">limit: number</span><br><span class="line">&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>使用 MapReduce 要实现两个函数 Map 函数和 Reduce 函数,Map 函数调用 emit(key, value), 遍历 collection 中所有的记录, 将key 与 value 传递给 Reduce 函数进行处理。<br>Map 函数必须调用 emit(key, value) 返回键值对。<br>参数说明:<br>map ：映射函数 (生成键值对序列,作为 reduce 函数参数)。<br>reduce 统计函数，reduce函数的任务就是将key-values变成key-value，也就是把values数组变成一个单一的值value。。<br>out 统计结果存放集合 (不指定则使用临时集合,在客户端断开后自动删除)。<br>query 一个筛选条件，只有满足条件的文档才会调用map函数。（query。limit，sort可以随意组合）<br>sort 和limit结合的sort排序参数（也是在发往map函数前给文档排序），可以优化分组机制<br>limit 发往map函数的文档数量的上限（要是没有limit，单独使用sort的用处不大）<br>使用 MapReduce<br>考虑以下文档结构存储用户的文章，文档存储了用户的 user_name 和文章的 status字段：<br><figure class="highlight js"><figcaption><span>&#123;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"post_text"</span>: <span class="string">"w3cschool.cc 菜鸟教程，最全的技术文档。"</span>,</span><br><span class="line"><span class="string">"user_name"</span>: <span class="string">"mark"</span>,</span><br><span class="line"><span class="string">"status"</span>:<span class="string">"active"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>现在，我们将在 posts 集合中使用 mapReduce 函数来选取已发布的文章，并通过user_name分组，计算每个用户的文章数：<br><figure class="highlight js"><figcaption><span>>db.posts.mapReduce(</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; emit(<span class="keyword">this</span>.user_id,<span class="number">1</span>); &#125;,</span><br><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">key, values</span>) </span>&#123;<span class="keyword">return</span> <span class="built_in">Array</span>.sum(values)&#125;,</span><br><span class="line">&#123;</span><br><span class="line">query:&#123;status:<span class="string">"active"</span>&#125;,</span><br><span class="line">out:<span class="string">"post_total"</span></span><br><span class="line">&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>以上 mapReduce 输出结果为：<br><figure class="highlight js"><figcaption><span>&#123;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"result"</span> : <span class="string">"post_total"</span>,</span><br><span class="line"><span class="string">"timeMillis"</span> : <span class="number">9</span>,</span><br><span class="line"><span class="string">"counts"</span> : &#123;</span><br><span class="line"><span class="string">"input"</span> : <span class="number">4</span>,</span><br><span class="line"><span class="string">"emit"</span> : <span class="number">4</span>,</span><br><span class="line"><span class="string">"reduce"</span> : <span class="number">2</span>,</span><br><span class="line"><span class="string">"output"</span> : <span class="number">2</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">"ok"</span> : <span class="number">1</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>结果表明，共有4个符合查询条件（status:”active”）的文档， 在map函数中生成了4个键值对文档，最后使用reduce函数将相同的键值分为两组。<br>具体参数说明：<br>result：储存结果的collection的名字,这是个临时集合，MapReduce的连接关闭后自动就被删除了。<br>timeMillis：执行花费的时间，毫秒为单位<br>input：满足条件被发送到map函数的文档个数<br>emit：在map函数中emit被调用的次数，也就是所有集合中的数据总量<br>ouput：结果集合中的文档个数（count对调试非常有帮助）<br>ok：是否成功，成功为1<br>err：如果失败，这里可以有失败原因，不过从经验上来看，原因比较模糊，作用不大<br>使用 find 操作符来查看 mapReduce 的查询结果：<br><figure class="highlight js"><figcaption><span>>db.posts.mapReduce(</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; emit(<span class="keyword">this</span>.user_id,<span class="number">1</span>); &#125;,</span><br><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">key, values</span>) </span>&#123;<span class="keyword">return</span> <span class="built_in">Array</span>.sum(values)&#125;,</span><br><span class="line">&#123;</span><br><span class="line">query:&#123;status:<span class="string">"active"</span>&#125;,</span><br><span class="line">out:<span class="string">"post_total"</span></span><br><span class="line">&#125;</span><br><span class="line">).find()</span><br></pre></td></tr></table></figure></p>
<p>以上查询显示如下结果，两个用户 tom 和 mark 有两个发布的文章:<br><figure class="highlight js"><figcaption><span>&#123; "_id" : "tom", "value" : 2 &#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="string">"_id"</span> : <span class="string">"mark"</span>, <span class="string">"value"</span> : <span class="number">2</span> &#125;</span><br></pre></td></tr></table></figure></p>
<p>用类似的方式，MapReduce可以被用来构建大型复杂的聚合查询。<br>Map函数和Reduce函数可以使用 JavaScript 来实现，是的MapReduce的使用非常灵活和强大。</p>
<p>MongoDB 全文检索<br>全文检索对每一个词建立一个索引，指明该词在文章中出现的次数和位置，当用户查询时，检索程序就根据事先建立的索引进行查找，并将查找的结果反馈给用户的检索方式。<br>这个过程类似于通过字典中的检索字表查字的过程。<br>MongoDB 从 2.4 版本开始支持全文检索，目前支持15种语言(暂时不支持中文)的全文索引。</p>
<p>启用全文检索<br>MongoDB 在 2.6 版本以后是默认开启全文检索的，如果你使用之前的版本，你需要使用以下代码来启用全文检索:<br><figure class="highlight js"><figcaption><span>>db.adminCommand(&#123;setParameter:true,textSearchEnabled:true&#125;)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">或者使用命令：</span><br><span class="line"><span class="string">``</span><span class="string">`js mongod --setParameter textSearchEnabled=true</span></span><br></pre></td></tr></table></figure></p>
<p>创建全文索引<br>考虑以下 posts 集合的文档数据，包含了文章内容（post_text）及标签(tags)：<br><figure class="highlight js"><figcaption><span>&#123;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"post_text"</span>: <span class="string">"enjoy the mongodb articles on w3cschool.cc"</span>,</span><br><span class="line"><span class="string">"tags"</span>: [</span><br><span class="line"><span class="string">"mongodb"</span>,</span><br><span class="line"><span class="string">"w3cschool"</span></span><br><span class="line">]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们可以对 post_text 字段建立全文索引，这样我们可以搜索文章内的内容：<br><figure class="highlight js"><figcaption><span>>db.posts.ensureIndex(&#123;post_text:"text"&#125;)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">使用全文索引</span><br><span class="line">现在我们已经对 post_text 建立了全文索引，我们可以搜索文章中的关键词w3cschool.cc：</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt;db.posts.find(&#123;$text:&#123;$search:"w3cschool.cc"&#125;&#125;)</span></span><br></pre></td></tr></table></figure></p>
<p>以下命令返回了如下包含w3cschool.cc关键词的文档数据：<br><figure class="highlight js"><figcaption><span>&#123;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"_id"</span> : ObjectId(<span class="string">"53493d14d852429c10000002"</span>),</span><br><span class="line"><span class="string">"post_text"</span> : <span class="string">"enjoy the mongodb articles on w3cschool.cc"</span>,</span><br><span class="line"><span class="string">"tags"</span> : [ <span class="string">"mongodb"</span>, <span class="string">"w3cschool"</span> ]</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"_id"</span> : ObjectId(<span class="string">"53493d1fd852429c10000003"</span>),</span><br><span class="line"><span class="string">"post_text"</span> : <span class="string">"writing tutorials on w3cschool.cc"</span>,</span><br><span class="line"><span class="string">"tags"</span> : [ <span class="string">"mongodb"</span>, <span class="string">"tutorial"</span> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果你使用的是旧版本的MongoDB，你可以使用以下命令：<br><figure class="highlight js"><figcaption><span>>db.posts.runCommand("text",&#123;search:" w3cschool.cc"&#125;)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">使用全文索引可以提高搜索效率。</span><br><span class="line">删除全文索引</span><br><span class="line">删除已存在的全文索引，可以使用 find 命令查找索引名：</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt;db.posts.getIndexes()</span></span><br></pre></td></tr></table></figure></p>
<p>通过以上命令获取索引名，本例的索引名为post_text_text，执行以下命令来删除索引：<br><figure class="highlight js"><figcaption><span>>db.posts.dropIndex("post_text_text")```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">MongoDB 正则表达式</span><br><span class="line">正则表达式是使用单个字符串来描述、匹配一系列符合某个句法规则的字符串。</span><br><span class="line">许多程序设计语言都支持利用正则表达式进行字符串操作。</span><br><span class="line">MongoDB 使用 $regex 操作符来设置匹配字符串的正则表达式。</span><br><span class="line">MongoDB使用PCRE (Perl Compatible Regular Expression) 作为正则表达式语言。</span><br><span class="line">不同于全文检索，我们使用正则表达式不需要做任何配置。</span><br><span class="line">考虑以下 posts 集合的文档结构，该文档包含了文章内容和标签：</span><br><span class="line"><span class="string">``</span><span class="string">`js &#123;</span><br><span class="line">"post_text": "enjoy the mongodb articles on tutorialspoint",</span><br><span class="line">"tags": [</span><br><span class="line">"mongodb",</span><br><span class="line">"tutorialspoint"</span><br><span class="line">]</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>使用正则表达式<br>以下命令使用正则表达式查找包含 w3cschool.cc 字符串的文章：<br><figure class="highlight js"><figcaption><span>>db.posts.find(&#123;post_text:&#123;$regex:"w3cschool.cc"&#125;&#125;)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">以上查询也可以写为：</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt;db.posts.find(&#123;post_text:/w3cschool.cc/&#125;)</span></span><br></pre></td></tr></table></figure></p>
<p>不区分大小写的正则表达式<br>如果检索需要不区分大小写，我们可以设置 $options 为 $i。<br>以下命令将查找不区分大小写的字符串 w3cschool.cc：<br><figure class="highlight js"><figcaption><span>>db.posts.find(&#123;post_text:&#123;$regex:"w3cschool.cc",$options:"$i"&#125;&#125;)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">集合中会返回所有包含字符串 w3cschool.cc 的数据，且不区分大小写：</span><br><span class="line"><span class="string">``</span><span class="string">`js &#123;</span><br><span class="line">"_id" : ObjectId("53493d37d852429c10000004"),</span><br><span class="line">"post_text" : "hey! this is my post on W3Cschool.cc",</span><br><span class="line">"tags" : [ "tutorialspoint" ]</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>数组元素使用正则表达式<br>我们还可以在数组字段中使用正则表达式来查找内容。 这在标签的实现上非常有用，如果你需要查找包含以 tutorial 开头的标签数据(tutorial 或 tutorials 或 tutorialpoint 或 tutorialphp)， 你可以使用以下代码：<br><figure class="highlight js"><figcaption><span>>db.posts.find(&#123;tags:&#123;$regex:"tutorial"&#125;&#125;)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">优化正则表达式查询</span><br><span class="line">如果你的文档中字段设置了索引，那么使用索引相比于正则表达式匹配查找所有的数据查询速度更快。</span><br><span class="line">如果正则表达式是前缀表达式，所有匹配的数据将以指定的前缀字符串为开始。例如： 如果正则表达式为 ^tut ，查询语句将查找以 tut 为开头的字符串。</span><br><span class="line">这里面使用正则表达式有两点需要注意：</span><br><span class="line">正则表达式中使用变量。一定要使用<span class="built_in">eval</span>将组合的字符串进行转换，不能直接将字符串拼接后传入给表达式。否则没有报错信息，只是结果为空！实例如下：</span><br><span class="line"><span class="string">``</span><span class="string">`js var name=eval("/" + 变量值key +"/i");</span></span><br></pre></td></tr></table></figure></p>
<p>以下是模糊查询包含title关键词, 且不区分大小写:<br><figure class="highlight js"><figcaption><span>title:eval("/"+title+"/i")</span><a href="//">等同于 title:&#123;$regex:title,$Option:"$i"&#125;```</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">MongoDB GridFS</span><br><span class="line">GridFS 用于存储和恢复那些超过<span class="number">16</span>M（BSON文件限制）的文件(如：图片、音频、视频等)。</span><br><span class="line">GridFS 也是文件存储的一种方式，但是它是存储在MonoDB的集合中。</span><br><span class="line">GridFS 可以更好的存储大于<span class="number">16</span>M的文件。</span><br><span class="line">GridFS 会将大文件对象分割成多个小的chunk(文件片段),一般为<span class="number">256</span>k/个,每个chunk将作为MongoDB的一个文档(<span class="built_in">document</span>)被存储在chunks集合中。</span><br><span class="line">GridFS 用两个集合来存储一个文件：fs.files与fs.chunks。</span><br><span class="line">每个文件的实际内容被存在chunks(二进制数据)中,和文件有关的meta数据(filename,content_type,还有用户自定义的属性)将会被存在files集合中。</span><br><span class="line">以下是简单的 fs.files 集合文档：</span><br><span class="line"><span class="string">``</span><span class="string">`js &#123;</span><br><span class="line">"filename": "test.txt",</span><br><span class="line">"chunkSize": NumberInt(261120),</span><br><span class="line">"uploadDate": ISODate("2014-04-13T11:32:33.557Z"),</span><br><span class="line">"md5": "7b762939321e146569b07f72c62cca4f",</span><br><span class="line">"length": NumberInt(646)</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>以下是简单的 fs.chunks 集合文档：<br>{<br>“files_id”: ObjectId(“534a75d19f54bfec8a2fe44b”),<br>“n”: NumberInt(0),<br>“data”: “Mongo Binary Data”<br>}<br>GridFS 添加文件<br>现在我们使用 GridFS 的 put 命令来存储 mp3 文件。 调用 MongoDB 安装目录下bin的 mongofiles.exe工具。<br>打开命令提示符，进入到MongoDB的安装目录的bin目录中，找到mongofiles.exe，并输入下面的代码：<br><figure class="highlight js"><figcaption><span>>mongofiles.exe -d gridfs put song.mp3```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GridFS 是存储文件的数据名称。如果不存在该数据库，MongoDB会自动创建。Song.mp3 是音频文件名。</span><br><span class="line">使用以下命令来查看数据库中文件的文档：</span><br><span class="line">&gt;db.fs.files.find()</span><br><span class="line">以上命令执行后返回以下文档数据：</span><br><span class="line"><span class="string">``</span><span class="string">`js &#123;</span><br><span class="line">_id: ObjectId('534a811bf8b4aa4d33fdf94d'),</span><br><span class="line">filename: "song.mp3",</span><br><span class="line">chunkSize: 261120,</span><br><span class="line">uploadDate: new Date(1397391643474), md5: "e4f53379c909f7bed2e9d631e15c1c41",</span><br><span class="line">length: 10401959</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>我们可以看到 fs.chunks 集合中所有的区块，以下我们得到了文件的 _id 值，我们可以根据这个 _id 获取区块(chunk)的数据：<br><figure class="highlight js"><figcaption><span>>db.fs.chunks.find(&#123;files_id:ObjectId('534a811bf8b4aa4d33fdf94d')&#125;)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">以上实例中，查询返回了 <span class="number">40</span> 个文档的数据，意味着mp3文件被存储在<span class="number">40</span>个区块中。</span><br><span class="line"></span><br><span class="line">MongoDB 固定集合（Capped Collections）</span><br><span class="line">MongoDB 固定集合（Capped Collections）是性能出色且有着固定大小的集合，对于大小固定，我们可以想象其就像一个环形队列，当集合空间用完后，再插入的元素就会覆盖最初始的头部的元素！</span><br><span class="line">创建固定集合</span><br><span class="line">我们通过createCollection来创建一个固定集合，且capped选项设置为<span class="literal">true</span>：</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt;db.createCollection("cappedLogCollection",&#123;capped:true,size:10000&#125;)</span></span><br></pre></td></tr></table></figure></p>
<p>还可以指定文档个数,加上max:1000属性：<br><figure class="highlight js"><figcaption><span>>db.createCollection("cappedLogCollection",&#123;capped:true,size:10000,max:1000&#125;)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">判断集合是否为固定集合:</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt;db.cappedLogCollection.isCapped()</span></span><br></pre></td></tr></table></figure></p>
<p>如果需要将已存在的集合转换为固定集合可以使用以下命令：<br><figure class="highlight js"><figcaption><span>>db.runCommand(&#123;"convertToCapped":"posts",size:10000&#125;)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">以上代码将我们已存在的 posts 集合转换为固定集合。</span><br><span class="line">固定集合查询</span><br><span class="line">固定集合文档按照插入顺序储存的,默认情况下查询就是按照插入顺序返回的,也可以使用$natural调整返回顺序。</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt;db.cappedLogCollection.find().sort(&#123;$natural:-1&#125;)</span></span><br></pre></td></tr></table></figure></p>
<p>固定集合的功能特点<br>可以插入及更新,但更新不能超出collection的大小,否则更新失败,不允许删除,但是可以调用drop()删除集合中的所有行,但是drop后需要显式地重建集合。<br>在32位机子上一个cappped collection的最大值约为482.5M,64位上只受系统文件大小的限制。<br>固定集合属性及用法<br>属性<br>属性1:对固定集合进行插入速度极快<br>属性2:按照插入顺序的查询输出速度极快<br>属性3:能够在插入最新数据时,淘汰最早的数据<br>用法<br>用法1:储存日志信息<br>用法2:缓存一些少量的文档</p>
<p>MongoDB 自动增长<br>MongoDB 没有像 SQL 一样有自动增长的功能， MongoDB 的 _id 是系统自动生成的12字节唯一标识。<br>但在某些情况下，我们可能需要实现 ObjectId 自动增长功能。<br>由于 MongoDB 没有实现这个功能，我们可以通过编程的方式来实现，以下我们将在 counters 集合中实现_id字段自动增长。<br>使用 counters 集合<br>考虑以下 products 文档。我们希望 _id 字段实现 从 1,2,3,4 到 n 的自动增长功能。<br><figure class="highlight js"><figcaption><span>&#123;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"_id"</span>:<span class="number">1</span>,</span><br><span class="line"><span class="string">"product_name"</span>: <span class="string">"Apple iPhone"</span>,</span><br><span class="line"><span class="string">"category"</span>: <span class="string">"mobiles"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>为此，创建 counters 集合，序列字段值可以实现自动长：</p>
<blockquote>
<p>db.createCollection(“counters”)<br>现在我们向 counters 集合中插入以下文档，使用 productid 作为 key:<br><figure class="highlight js"><figcaption><span>&#123;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"_id"</span>:<span class="string">"productid"</span>,</span><br><span class="line"><span class="string">"sequence_value"</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>sequence_value 字段是序列通过自动增长后的一个值。<br>使用以下命令插入 counters 集合的序列文档中：<br><figure class="highlight js"><figcaption><span>>db.counters.insert(&#123;_id:"productid",sequence_value:0&#125;)```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">创建 Javascript 函数</span><br><span class="line">现在，我们创建函数 getNextSequenceValue 来作为序列名的输入， 指定的序列会自动增长 <span class="number">1</span> 并返回最新序列值。在本文的实例中序列名为 productid 。</span><br><span class="line"><span class="string">``</span><span class="string">`js &gt;function getNextSequenceValue(sequenceName)&#123;</span><br><span class="line">var sequenceDocument = db.counters.findAndModify(</span><br><span class="line">&#123;</span><br><span class="line">query:&#123;_id: sequenceName &#125;,</span><br><span class="line">update: &#123;$inc:&#123;sequence_value:1&#125;&#125;,</span><br><span class="line">new:true</span><br><span class="line">&#125;);</span><br><span class="line">return sequenceDocument.sequence_value;</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>使用 Javascript 函数<br>接下来我们将使用 getNextSequenceValue 函数创建一个新的文档， 并设置文档 _id 自动为返回的序列值：<br><figure class="highlight js"><figcaption><span>>db.products.insert(&#123;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"_id"</span>:getNextSequenceValue(<span class="string">"productid"</span>),</span><br><span class="line"><span class="string">"product_name"</span>:<span class="string">"Apple iPhone"</span>,</span><br><span class="line"><span class="string">"category"</span>:<span class="string">"mobiles"</span>&#125;)</span><br><span class="line"></span><br><span class="line">&gt;db.products.insert(&#123;</span><br><span class="line"><span class="string">"_id"</span>:getNextSequenceValue(<span class="string">"productid"</span>),</span><br><span class="line"><span class="string">"product_name"</span>:<span class="string">"Samsung S3"</span>,</span><br><span class="line"><span class="string">"category"</span>:<span class="string">"mobiles"</span>&#125;)</span><br></pre></td></tr></table></figure></p>
<p>就如你所看到的，我们使用 getNextSequenceValue 函数来设置 _id 字段。<br>为了验证函数是否有效，我们可以使用以下命令读取文档：<br><figure class="highlight js"><figcaption><span>>db.prodcuts.find()```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">以上命令将返回以下结果，我们发现 _id 字段是自增长的：</span><br><span class="line"><span class="string">``</span><span class="string">`js &#123; "_id" : 1, "product_name" : "Apple iPhone", "category" : "mobiles"&#125;</span><br><span class="line"></span><br><span class="line">&#123; "_id" : 2, "product_name" : "Samsung S3", "category" : "mobiles" &#125;</span></span><br></pre></td></tr></table></figure></p>
<p>停止服务：<br><figure class="highlight js"><figcaption><span>kill -9 PID```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">正常停止：</span><br><span class="line"><span class="string">``</span><span class="string">`js kill -2 PID</span></span><br></pre></td></tr></table></figure></p>
<p>或者<br><figure class="highlight js"><figcaption><span>use admin</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.shutdownServer()</span><br></pre></td></tr></table></figure></p>
<p>注意：如果再次启动的时候报错，则删除lock文件</p>
<p>&nbsp;</p>
<p></p><h1 id="数据库管理">数据库管理</h1><br><strong>新建数据库</strong><p></p>
<p>MongoDB的shell没有提供新建数据库的功能，不过你可以这样：</p>
<pre><code>use accounts
db.createCollection('accounts')
</code></pre>
当你使用“use accounts”切换到名为accounts的数据库时，实际上什么也没发生，只有当你调用了db.createCollection之后，新的数据库才被保存，然后你使用“show dbs”就可以看到新建的库。

<strong>删除数据库</strong>

删除数据库需要切换到指定的库，然后调用dropDatabase()。如下：
<pre><code>use accounts
db.dropDatabase()
</code></pre>
调用dropDatabase之后，可以使用“show dbs”查看。

<strong>创建集合</strong>

之前新建数据库时已用到，调用createCollection即可。

<strong>显示集合</strong>

这样：
<pre><code>use accounts
show collections
</code></pre>
<strong>获取指定名字的集合</strong>

要得到集合对象，可以这样：
<pre><code>use accounts
coll = db.getCollection("accounts")
</code></pre>
<strong>删除集合</strong>

要删除集合，需要调用集合对象的drop()方法。这样：
<pre><code>use accounts
coll = db.getCollection("accounts")
coll.drop();
</code></pre>
<strong>向集合中添加文档</strong>

要把文档添加到集合，需要先得到collection对象，然后调用insert(document)方法。document参数是一个JSON对象。下面的命令往accounts集合里添加了两个用户：
<pre><code>use accounts
coll = db.getCollection("accounts")
coll.insert({name:"ZhangSan",password:"123456"})
coll.insert({name:"WangEr",password:"nicai"})
</code></pre>
<strong>在集合中查找</strong>

使用集合对象的find()方法，可以列出集合里的所有文档。这样：
<pre><code>use accounts
coll = db.getCollection("accounts")
coll.find()
</code></pre>
带参数的find()方法可以根据某个字段来查找：
<pre><code>coll.find({name:"ZhangSan"})
</code></pre>
<strong>从集合中删除文档</strong>

使用collection对象的remove(object)方法可以删除文档。它的参数是JS对象，它通过将你传入对象的属性与数据库内数据比对来匹配某一个文档，匹配到后删除，匹配不上就拉倒。假如你传递一个空的JS对象，就会删除这个集合里所有的文档。比如下面这样：
<pre><code>use accounts
coll = db.getCollection("accounts")
coll.insert({name:"QianQi",password:"888888"})
coll.find()
coll.remove({name:"WangEr"})
coll.find()
coll.remove({})
coll.find()
</code></pre>
<strong>更新集合中的文档</strong>

collection对象提供了两种方法来更新文档：save(object)和update(query, update, options)。

save可以直接更新一个对象，下面的代码将ZhangSan的密码修改为567890：
<pre><code>coll.save({_id:ObjectId("55cc25b360bcee730bafd2bf"),name:"ZhangSan",password:"567890"})
</code></pre>
下面的update方法与上面的save效果一样：
<pre><code>coll.update({name:"ZhangSan"},{name:"ZhangSan",password:"567890"})
</code></pre>
update()的第二个参数update是一个对象，能指定更新时用的运算符，比如$set可以设置字段的值，下面代码与前面等效：
<pre><code>coll.update({name:"ZhangSan"},{$set: {password:"567890"}});</code></pre>
					</div>


					<div class="content-tag">

<a class="tag-link" href="/tags/mongoDB/">mongoDB</a>, <a class="tag-link" href="/tags/nodejs/">nodejs</a>, <a class="tag-link" href="/tags/note/">note</a>, <a class="tag-link" href="/tags/笔记/">笔记</a>

					</div>



				</article>
			</div>

		</div>

		<div class="panel-post-nav">
			<div class="box-post-nav">


					<a href="/2016/04/07/Mongoose--学习笔记/" title="Mongoose--学习笔记">&larr; Prev</a>



					<a href="/2016/04/07/Nodejs--学习笔记/" title="Nodejs--学习笔记">Next &rarr;</a>


			</div>
		</div>
		<div class="content-comments">
		
  <section id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="2016/04/07/MongoDB--学习笔记/index.html" data-title="MongoDB--学习笔记" data-url="/2016/04/07/MongoDB--学习笔记/"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:'pengweb'};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
    <!-- 多说公共JS代码 end -->
  </section>
  
		</div>
		

	</div>

	<div class="layout-footer" style="clear: both">
		<div class="panel-footer">
			<div class="box-footer">
				<footer class="footer">
					<p class="cr">&copy; 2016 <a href="https://github.com/pengweb"  target="_blank" target="_blank">Pengzhang</a> 
					<span class="theme">Powered: <a href="https://github.com/pengweb/pengweb.github.io" target="_blank">pengweb.net</a>, 京ICP备: <a href="" target="_blank">15017479</a></span>
					</p>

					
				</footer>
			</div>
		</div>
	</div>




</body>
</html>
